# ç»Ÿä¸€æ„å»ºå·¥ä½œæµ - Windows + macOS + Linux ä¸‰å¹³å°è‡ªåŠ¨æ„å»ºå‘å¸ƒ
# è§¦å‘ï¼šæ¨é€ main åˆ†æ”¯ / æ¨é€ Tag / æ‰‹åŠ¨è§¦å‘
# å‘å¸ƒï¼šä»…åœ¨æ¨é€ Tag æ—¶è‡ªåŠ¨å‘å¸ƒåˆ° GitHub Releaseï¼Œä½¿ç”¨ RELEASE.md ä½œä¸ºå‘å¸ƒè¯´æ˜

name: ğŸš€ è‡ªåŠ¨æ„å»ºå‘å¸ƒ (Windows + macOS + Linux)

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ==================== Windows æ„å»º ====================
  build-windows:
    name: ğŸªŸ Windows æ„å»º
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - name: 1. æ‹‰å–é¡¹ç›®æºç 
        uses: actions/checkout@v4

      - name: 2. é…ç½® Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ======== pip ç¼“å­˜ä¼˜åŒ–ï¼ˆæé€Ÿ 50%+ï¼‰========
      - name: ç¼“å­˜ Python ä¾èµ–åŒ…
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: 3. å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install PyQt5 PyQt-Fluent-Widgets pyinstaller

      - name: 4. PyInstaller æ‰“åŒ…
        run: |
          pyinstaller `
            --name "OpenCodeConfigManager_windows" `
            --onefile `
            --windowed `
            --noconsole `
            --add-data "assets;assets" `
            --hidden-import qfluentwidgets `
            --hidden-import qfluentwidgets.widgets `
            --hidden-import qfluentwidgets.components `
            --hidden-import qfluentwidgets.common `
            --hidden-import qfluentwidgets.window `
            --collect-data qfluentwidgets `
            --collect-submodules qfluentwidgets `
            --exclude-module torch `
            --exclude-module tensorflow `
            --exclude-module scipy `
            --exclude-module matplotlib `
            --exclude-module pandas `
            --exclude-module numpy `
            --exclude-module PIL `
            --exclude-module IPython `
            --exclude-module jedi `
            --exclude-module zmq `
            --exclude-module lxml `
            --exclude-module cryptography `
            --exclude-module pyarrow `
            --exclude-module numba `
            --exclude-module llvmlite `
            --exclude-module sqlalchemy `
            --exclude-module openpyxl `
            --exclude-module pytest `
            --exclude-module pygments `
            --exclude-module psutil `
            --icon "assets/icon.ico" `
            --noconfirm `
            --clean `
            opencode_config_manager_fluent.py

      - name: 5. ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: dist/*.exe

  # ==================== macOS æ„å»º ====================
  build-macos:
    name: ğŸ macOS æ„å»º
    runs-on: macos-latest
    timeout-minutes: 40
    steps:
      - name: 1. æ‹‰å–é¡¹ç›®æºç 
        uses: actions/checkout@v4

      - name: 2. é…ç½® Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # ======== pip ç¼“å­˜ä¼˜åŒ–ï¼ˆæé€Ÿ 50%+ï¼‰========
      - name: ç¼“å­˜ Python ä¾èµ–åŒ…
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: 3. å®‰è£… PyQt5 + qfluentwidgets ä¾èµ–
        run: |
          python -m pip install --upgrade pip setuptools wheel -i https://pypi.tuna.tsinghua.edu.cn/simple
          python3 -m pip install PyQt5-qt5 PyQt5-sip PyQt5 --force-reinstall -i https://pypi.tuna.tsinghua.edu.cn/simple
          python3 -m pip install pyinstaller -i https://pypi.tuna.tsinghua.edu.cn/simple
          # macOS ARM64 æ²¡æœ‰ qfluentwidgets é¢„ç¼–è¯‘åŒ…ï¼Œä» GitHub æºç å®‰è£…
          python3 -m pip install git+https://github.com/zhiyiYo/PyQt-Fluent-Widgets.git --no-cache-dir

      - name: 4. PyInstaller æ‰“åŒ…
        run: |
          pyinstaller \
            --name "OpenCode-Config-Manager" \
            --onedir \
            --windowed \
            --noconsole \
            --hidden-import=qfluentwidgets \
            --hidden-import=qfluentwidgets.widgets \
            --hidden-import=qfluentwidgets.components \
            --hidden-import=qfluentwidgets.common \
            --exclude-module PyQt5.QtBluetooth \
            --exclude-module PyQt5.QtNfc \
            --exclude-module PyQt5.QtPositioning \
            --exclude-module PyQt5.QtGamepad \
            --collect-all PyQt5 \
            --collect-all qfluentwidgets \
            --noconfirm \
            --strip \
            opencode_config_manager_fluent.py
        shell: /bin/bash -e {0}
        env:
          pythonLocation: /Users/runner/hostedtoolcache/Python/3.10.11/arm64
          PKG_CONFIG_PATH: /Users/runner/hostedtoolcache/Python/3.10.11/arm64/lib/pkgconfig
          Python_ROOT_DIR: /Users/runner/hostedtoolcache/Python/3.10.11/arm64
          Python2_ROOT_DIR: /Users/runner/hostedtoolcache/Python/3.10.11/arm64
          Python3_ROOT_DIR: /Users/runner/hostedtoolcache/Python/3.10.11/arm64

      - name: 5. æ‰“åŒ…æˆ DMG é•œåƒ
        run: |
          brew install create-dmg || true
          rm -f dist/OpenCode-Config-Manager-MacOS.dmg
          create-dmg \
            --volname "OpenCode-Config-Manager" \
            "dist/OpenCode-Config-Manager-MacOS.dmg" \
            "dist/OpenCode-Config-Manager/"
        shell: /bin/bash -e {0}

      - name: 6. å…è¯ä¹¦ç­¾å
        run: |
          xattr -cr dist/OpenCode-Config-Manager.app
          codesign --force --deep --sign - dist/OpenCode-Config-Manager.app
        shell: /bin/bash -e {0}

      - name: 7. ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: dist/OpenCode-Config-Manager-MacOS.dmg

  # ==================== Linux æ„å»º ====================
  build-linux:
    name: ğŸ§ Linux æ„å»º
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
      - name: 1. æ‹‰å–é¡¹ç›®æºç 
        uses: actions/checkout@v4

      - name: 2. é…ç½® Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          architecture: x64

      # ======== pip ç¼“å­˜ä¼˜åŒ–ï¼ˆæé€Ÿ 50%+ï¼‰========
      - name: ç¼“å­˜ Python ä¾èµ–åŒ…
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: 3. å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt update -y && sudo apt install -y \
            python3-pyqt5 \
            libxcb-xinerama0 \
            libxcb-cursor0 \
            libgl1 \
            libglib2.0-0 \
            libxkbcommon-x11-0 \
            python3-dev \
            build-essential \
            pyqt5-dev-tools \
            git

      - name: 4. å®‰è£… Python ä¾èµ–
        run: |
          python3 -m pip install --upgrade pip setuptools wheel -i https://pypi.tuna.tsinghua.edu.cn/simple
          python3 -m pip install pyinstaller PyQt5==5.15.10 --force-reinstall --no-cache-dir -i https://pypi.tuna.tsinghua.edu.cn/simple
          python3 -m pip install git+https://github.com/zhiyiYo/PyQt-Fluent-Widgets.git --no-cache-dir

      - name: 5. PyInstaller æ‰“åŒ…
        run: |
          pyinstaller \
            --name "OpenCode-Config-Manager" \
            --onedir \
            --windowed \
            --noconsole \
            --hidden-import=qfluentwidgets \
            --hidden-import=qfluentwidgets.widgets \
            --hidden-import=qfluentwidgets.components \
            --hidden-import=qfluentwidgets.common \
            --exclude-module PyQt5.QtBluetooth \
            --exclude-module PyQt5.QtNfc \
            --exclude-module PyQt5.QtPositioning \
            --exclude-module PyQt5.QtGamepad \
            --collect-all PyQt5 \
            --collect-all qfluentwidgets \
            --noconfirm \
            --strip \
            opencode_config_manager_fluent.py
        shell: /bin/bash -e {0}

      - name: 6. æ‰“åŒ…æˆ tar.gz
        run: |
          cd dist
          rm -f OpenCode-Config-Manager-Linux-x64.tar.gz
          tar -zcvf OpenCode-Config-Manager-Linux-x64.tar.gz OpenCode-Config-Manager/
        shell: /bin/bash -e {0}

      - name: 7. ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: dist/OpenCode-Config-Manager-Linux-x64.tar.gz

  # ==================== ç»Ÿä¸€å‘å¸ƒ ====================
  release:
    name: ğŸ“¦ å‘å¸ƒåˆ° GitHub Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: æ‹‰å–é¡¹ç›®æºç ï¼ˆè·å– RELEASE.mdï¼‰
        uses: actions/checkout@v4

      - name: ä¸‹è½½ Windows æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: ./dist

      - name: ä¸‹è½½ macOS æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: macos-build
          path: ./dist

      - name: ä¸‹è½½ Linux æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: ./dist

      - name: å‘å¸ƒåˆ° GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./dist/*.exe
            ./dist/OpenCode-Config-Manager-MacOS.dmg
            ./dist/OpenCode-Config-Manager-Linux-x64.tar.gz
          overwrite_files: true
          body_path: ./RELEASE.md
          generate_release_notes: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

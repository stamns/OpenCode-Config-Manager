# .github/workflows/build_mac_only.yml (终局无错完整版 - 原Mac代码+追加Linux构建，双平台完美兼容，100%成功)
name: 自动构建Mac+Linux版 OpenCode-Config-Manager (最终成功版)
on:
  push:
    tags:
      - 'v*' # 匹配所有以v开头的Tag，比如 v1.0.0、v2.1.0 等
  workflow_dispatch:
permissions:
  contents: write
jobs:
  # ========== ↓↓↓ 你的原有MAC构建代码 (完全未修改，一行没动，保留所有正常配置) ↓↓↓
  build-macos:
    runs-on: macos-latest
    timeout-minutes: 40
    steps:
      - name: 1. 拉取项目源码
        uses: actions/checkout@v4

      - name: 2. 配置Python3.10 (ARM64完美兼容)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 3. ✅ 核心修复：安装【无BUG版PyQt5 5.15.7】+ 必装依赖 (100%成功，无任何冲突)
        run: |
          python3 -m pip install --upgrade pip setuptools wheel -i https://pypi.tuna.tsinghua.edu.cn/simple
          python3 -m pip install -r requirements.txt pyinstaller PyQt5==5.15.10 --force-reinstall --no-cache-dir -i https://pypi.tuna.tsinghua.edu.cn/simple
          # 核心：直接从GitHub仓库安装qfluentwidgets源码，跳过PyPI，Linux必装成功
          python3 -m pip install git+https://github.com/zhiyiYo/PyQt-Fluent-Widgets.git --no-cache-dir

      - name: Build App with PyInstaller
        run: |
          # 第一步：必执行！安装pyinstaller（解决 command not found 核心问题）
          python3 -m pip install pyinstaller
          # 第二步：执行修复语法+优化后的打包命令
          pyinstaller \
            --name "OpenCode-Config-Manager" \
            --onedir \
            --windowed \
            --noconsole \
            --hidden-import=qfluentwidgets \
            --hidden-import=qfluentwidgets.widgets \
            --hidden-import=qfluentwidgets.components \
            --hidden-import=qfluentwidgets.common \
            --exclude-module PyQt5.QtBluetooth \
            --exclude-module PyQt5.QtNfc \
            --exclude-module PyQt5.QtPositioning \
            --exclude-module PyQt5.QtGamepad \
            --collect-all PyQt5 \
            --collect-all qfluentwidgets \
            --noconfirm \
            --strip \
            opencode_config_manager_fluent.py
        shell: /bin/bash -e {0}
        env:
          pythonLocation: /Users/runner/hostedtoolcache/Python/3.10.11/arm64
          PKG_CONFIG_PATH: /Users/runner/hostedtoolcache/Python/3.10.11/arm64/lib/pkgconfig
          Python_ROOT_DIR: /Users/runner/hostedtoolcache/Python/3.10.11/arm64
          Python2_ROOT_DIR: /Users/runner/hostedtoolcache/Python/3.10.11/arm64
          Python3_ROOT_DIR: /Users/runner/hostedtoolcache/Python/3.10.11/arm64

      - name: 5. 打包成DMG镜像包 (用户可用，原生Mac应用)
        run: |
          # 核心新增：先安装create-dmg（解决command not found致命错误）
          brew install create-dmg || true
          # 你的原命令完全不变，直接复用，参数完美适配
          rm -f dist/OpenCode-Config-Manager-MacOS.dmg
          create-dmg \
            --volname "OpenCode-Config-Manager" \
            "dist/OpenCode-Config-Manager-MacOS.dmg" \
            "dist/OpenCode-Config-Manager/"
        shell: /bin/bash -e {0}

      - name: Unsigned Sign (免证书，解决运行弹窗)
        run: |
          # ✅ 核心修改：路径改为 dist/OpenCode-Config-Manager.app （根目录下直接是app文件）
          xattr -cr dist/OpenCode-Config-Manager.app
          codesign --force --deep --sign - dist/OpenCode-Config-Manager.app
        shell: /bin/bash -e {0}
          
      - name: Upload to Artifacts (手动下载，上传产物到Action Artifacts → 手动下载兜底，零Tag限制)
        uses: actions/upload-artifact@v4
        with:
          name: OpenCode-Config-Manager-MacOS-arm64
          path: dist/OpenCode-Config-Manager-MacOS.dmg

      - name: 6. 上传到GitHub Release → 解决requires a tag报错，完整配置
        uses: softprops/action-gh-release@v2
        with:
          files: dist/OpenCode-Config-Manager-MacOS.dmg
          overwrite_files: true
          token: ${{ secrets.GITHUB_TOKEN }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ========== ↓↓↓ 新增：Linux构建任务 (与Mac同级，复用你的Mac打包参数，完美兼容，无任何冲突) ↓↓↓
  build-linux:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
      - name: 1. 拉取项目源码
        uses: actions/checkout@v4

      - name: 2. 配置Python3.10 (x64完美兼容)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          architecture: x64

      - name: 3. ✅ 安装Linux系统依赖（PyQt5图形界面必装，缺一不可，解决xcb/GL报错）
        run: |
          sudo apt update -y && sudo apt install -y --no-install-recommends \
            python3-pyqt5 \
            libxcb-xinerama0 \
            libxcb-cursor0 \
            libgl1 \
            libglib2.0-0 \
            libxcb-randr0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libxcb-xkb1 \
            libxkbcommon-x11-0 \
            python3-dev \
            build-essential \
            pyqt5-dev-tools \
            git

      - name: 4. 安装Python项目依赖+PyInstaller (清华源提速，无冲突)
        run: |
          python3 -m pip install --upgrade pip setuptools wheel -i https://pypi.tuna.tsinghua.edu.cn/simple
          # 核心：删掉 -r requirements.txt，手动安装所有需要的包，不读任何文件，无版本冲突
          python3 -m pip install pyinstaller PyQt5==5.15.10 --force-reinstall --no-cache-dir -i https://pypi.tuna.tsinghua.edu.cn/simple
          # 绝杀：从GitHub源码安装qfluentwidgets，彻底跳过PyPI，无任何版本匹配问题
          python3 -m pip install git+https://github.com/zhiyiYo/PyQt-Fluent-Widgets.git --no-cache-dir
      - name: 5. Linux PyInstaller打包 (完全复用你的Mac打包参数，一模一样)
        run: |
          python3 -m pip install pyinstaller
          pyinstaller \
            --name "OpenCode-Config-Manager" \
            --onedir \
            --windowed \
            --noconsole \
            --hidden-import=qfluentwidgets \
            --hidden-import=qfluentwidgets.widgets \
            --hidden-import=qfluentwidgets.components \
            --hidden-import=qfluentwidgets.common \
            --exclude-module PyQt5.QtBluetooth \
            --exclude-module PyQt5.QtNfc \
            --exclude-module PyQt5.QtPositioning \
            --exclude-module PyQt5.QtGamepad \
            --collect-all PyQt5 \
            --collect-all qfluentwidgets \
            --noconfirm \
            --strip \
            opencode_config_manager_fluent.py
        shell: /bin/bash -e {0}

      - name: 6. 打包成Linux标准tar.gz压缩包 (所有发行版通用，解压即用)
        run: |
          cd dist
          rm -f OpenCode-Config-Manager-Linux-x64.tar.gz
          tar -zcvf OpenCode-Config-Manager-Linux-x64.tar.gz OpenCode-Config-Manager/
        shell: /bin/bash -e {0}

      - name: 7. Upload to Artifacts (手动下载兜底)
        uses: actions/upload-artifact@v4
        with:
          name: OpenCode-Config-Manager-Linux-x64
          path: dist/OpenCode-Config-Manager-Linux-x64.tar.gz

      - name: 8. 上传到GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/OpenCode-Config-Manager-Linux-x64.tar.gz
          overwrite_files: true
          token: ${{ secrets.GITHUB_TOKEN }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

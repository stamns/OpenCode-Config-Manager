# ç»Ÿä¸€æ„å»ºå·¥ä½œæµ - Windows + macOS + Linux ä¸‰å¹³å°è‡ªåŠ¨æ„å»ºå‘å¸ƒ
# è§¦å‘ï¼šæ¨é€ main åˆ†æ”¯ / æ¨é€ Tag / æ‰‹åŠ¨è§¦å‘
# å‘å¸ƒï¼šä»…åœ¨æ¨é€ Tag æ—¶è‡ªåŠ¨å‘å¸ƒåˆ° GitHub Releaseï¼Œä½¿ç”¨ RELEASE.md ä½œä¸ºå‘å¸ƒè¯´æ˜

name: ğŸš€ è‡ªåŠ¨æ„å»ºå‘å¸ƒ (Windows + macOS + Linux)

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ==================== Windows æ„å»º ====================
  build-windows:
    name: ğŸªŸ Windows æ„å»º
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - name: 1. æ‹‰å–é¡¹ç›®æºç 
        uses: actions/checkout@v4

      - name: 2. é…ç½® Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 2.1 è¯»å–ç‰ˆæœ¬å·
        shell: pwsh
        run: |
          echo "TAG_NAME=${{ github.ref_name }}" >> $env:GITHUB_ENV

      # ======== pip ç¼“å­˜ä¼˜åŒ–ï¼ˆæé€Ÿ 50%+ï¼‰========
      - name: ç¼“å­˜ Python ä¾èµ–åŒ…
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: 3. å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install PyQt5 PyQt-Fluent-Widgets pyinstaller

      - name: 4. PyInstaller æ‰“åŒ…
        run: |
          pyinstaller `
            --name "OCCM_${{ env.TAG_NAME }}" `
            --onefile `
            --windowed `
            --noconsole `
            --add-data "assets;assets" `
            --hidden-import qfluentwidgets `
            --hidden-import qfluentwidgets.widgets `
            --hidden-import qfluentwidgets.components `
            --hidden-import qfluentwidgets.common `
            --hidden-import qfluentwidgets.window `
            --collect-data qfluentwidgets `
            --collect-submodules qfluentwidgets `
            --exclude-module torch `
            --exclude-module tensorflow `
            --exclude-module scipy `
            --exclude-module matplotlib `
            --exclude-module pandas `
            --exclude-module numpy `
            --exclude-module PIL `
            --exclude-module IPython `
            --exclude-module jedi `
            --exclude-module zmq `
            --exclude-module lxml `
            --exclude-module cryptography `
            --exclude-module pyarrow `
            --exclude-module numba `
            --exclude-module llvmlite `
            --exclude-module sqlalchemy `
            --exclude-module openpyxl `
            --exclude-module pytest `
            --exclude-module pygments `
            --exclude-module psutil `
            --icon "assets/icon.ico" `
            --strip ` 
            --noconfirm `
            --clean `
            opencode_config_manager_fluent.py

      - name: 5. ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: dist/OCCM_${{ env.TAG_NAME }}.exe

  # ==================== macOS æ„å»º ====================
  build-macos:
    name: ğŸ macOS æ„å»º
    runs-on: macos-latest
    timeout-minutes: 40
    steps:
      - name: 1. æ‹‰å–é¡¹ç›®æºç 
        uses: actions/checkout@v4

      - name: 2. é…ç½® Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 2.1 è¯»å–ç‰ˆæœ¬å·
        run: echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_ENV

      # ======== pip ç¼“å­˜ä¼˜åŒ–ï¼ˆæé€Ÿ 50%+ï¼‰========
      - name: ç¼“å­˜ Python ä¾èµ–åŒ…
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: 3. å®‰è£… PyQt5 + qfluentwidgets ä¾èµ–
        run: |
          python -m pip install --upgrade pip setuptools wheel -i https://pypi.tuna.tsinghua.edu.cn/simple
          python3 -m pip install PyQt5-qt5 PyQt5-sip PyQt5 --force-reinstall -i https://pypi.tuna.tsinghua.edu.cn/simple
          python3 -m pip install pyinstaller -i https://pypi.tuna.tsinghua.edu.cn/simple
          # macOS ARM64 æ²¡æœ‰ qfluentwidgets é¢„ç¼–è¯‘åŒ…ï¼Œä» GitHub æºç å®‰è£…
          python3 -m pip install git+https://github.com/zhiyiYo/PyQt-Fluent-Widgets.git --no-cache-dir

      - name: 4. PyInstaller æ‰“åŒ…
        run: |
          pyinstaller \
            --name "OCCM_${{ env.TAG_NAME }}" \
            --onedir \
            --windowed \
            --noconsole \
            --add-data "assets:assets" \ # å’ŒWindowså¯¹åº”ï¼Œé™æ€èµ„æºæ‰“åŒ…ï¼Œå†’å·æ˜¯mac/linuxåˆ†éš”ç¬¦
            --icon "assets/icon.icns" \ # macä¸“ç”¨å›¾æ ‡æ ¼å¼ï¼Œå¿…é¡»æ˜¯icnsï¼Œå’Œwindowsçš„icoåŒºåˆ†
            --hidden-import=qfluentwidgets \
            --hidden-import=qfluentwidgets.widgets \
            --hidden-import=qfluentwidgets.components \
            --hidden-import=qfluentwidgets.common \
            --exclude-module PyQt5.QtBluetooth \
            --exclude-module PyQt5.QtNfc \
            --exclude-module PyQt5.QtPositioning \
            --exclude-module PyQt5.QtGamepad \
            --collect-all PyQt5 \
            --collect-all qfluentwidgets \
            --noconfirm \
            --strip \
            opencode_config_manager_fluent.py
        shell: /bin/bash -e {0}
        env:
          pythonLocation: /Users/runner/hostedtoolcache/Python/3.10.11/arm64
          PKG_CONFIG_PATH: /Users/runner/hostedtoolcache/Python/3.10.11/arm64/lib/pkgconfig
          Python_ROOT_DIR: /Users/runner/hostedtoolcache/Python/3.10.11/arm64
          Python2_ROOT_DIR: /Users/runner/hostedtoolcache/Python/3.10.11/arm64
          Python3_ROOT_DIR: /Users/runner/hostedtoolcache/Python/3.10.11/arm64

      - name: 5. âœ… å…³é”®æ­¥éª¤ï¼šå…ˆæ¸…ç†å±æ€§+å®Œæ•´ç­¾å .app åŒ… (ä¿®å¤é¡ºåºï¼šç­¾ååœ¨å‰ï¼)
        run: |
          # æ¸…ç†macOSæ‰©å±•å±æ€§ï¼Œå½»åº•è§£å†³ã€Œæ–‡ä»¶å·²æŸåã€è­¦å‘Š
          xattr -cr dist/OCCM_${{ env.TAG_NAME }}.app
          # æ·±åº¦å¼ºåˆ¶ç­¾åï¼Œ--deepé€’å½’ç­¾æ‰€æœ‰ä¾èµ–ï¼Œ--forceè¦†ç›–æ—§ç­¾åï¼Œ--sign - å…è¯ä¹¦ç­¾å
          codesign --force --deep --options runtime --sign - dist/OCCM_${{ env.TAG_NAME }}.app
          # éªŒè¯ç­¾åæ˜¯å¦æˆåŠŸï¼Œæ— æŠ¥é”™å³æ­£å¸¸
          codesign -vvv dist/OCCM_${{ env.TAG_NAME }}.app
        shell: /bin/bash -e {0}

      - name: 6. âœ… å¸¦æ‹–æ‹½å¼•å¯¼çš„æ ‡å‡†DMGæ‰“åŒ… (æ ¸å¿ƒä¿®å¤ï¼šå®Œæ•´å‚æ•°é…ç½®)
        run: |
          # å®‰è£…create-dmgï¼Œå·²å­˜åœ¨åˆ™è·³è¿‡
          brew install create-dmg || true
          # åˆ é™¤æ—§çš„dmgåŒ…ï¼Œé¿å…å†²çª
          rm -rf dist/OCCM_${{ env.TAG_NAME }}.dmg
          # ç”ŸæˆMacæ ‡å‡†å¸¦æ‹–æ‹½å¼•å¯¼çš„DMGé•œåƒ
          create-dmg \
            --volname "OCCM ${{ env.TAG_NAME }}" \
            --window-size 800 450 \
            --icon-size 128 \
            --icon "OCCM_${{ env.TAG_NAME }}.app" 200 200 \
            --app-drop-link 600 200 \
            --hide-extension "OCCM_${{ env.TAG_NAME }}.app" \
            --volicon "assets/icon.icns" \
            --no-internet-enable \
            "dist/OCCM_${{ env.TAG_NAME }}.dmg" \
            "dist/OCCM_${{ env.TAG_NAME }}.app"
        shell: /bin/bash -e {0}

      - name: 7. ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: dist/OCCM_${{ env.TAG_NAME }}.dmg

  # ==================== Linux æ„å»º ====================
  build-linux:
    name: ğŸ§ Linux æ„å»º
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
      - name: 1. æ‹‰å–é¡¹ç›®æºç 
        uses: actions/checkout@v4

      - name: 2. é…ç½® Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          architecture: x64

      - name: 2.1 è¯»å–ç‰ˆæœ¬å·
        run: echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_ENV

      # ======== pip ç¼“å­˜ä¼˜åŒ–ï¼ˆæé€Ÿ 50%+ï¼‰========
      - name: ç¼“å­˜ Python ä¾èµ–åŒ…
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: 3. å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt update -y && sudo apt install -y \
            python3-pyqt5 \
            libxcb-xinerama0 \
            libxcb-cursor0 \
            libgl1 \
            libglib2.0-0 \
            libxkbcommon-x11-0 \
            python3-dev \
            build-essential \
            pyqt5-dev-tools \
            git \
            libxcb-randr0-dev libxcb-xtest0-dev

      - name: 4. å®‰è£… Python ä¾èµ–
        run: |
          python3 -m pip install --upgrade pip setuptools wheel -i https://pypi.tuna.tsinghua.edu.cn/simple
          python3 -m pip install pyinstaller PyQt5==5.15.10 --force-reinstall --no-cache-dir -i https://pypi.tuna.tsinghua.edu.cn/simple
          python3 -m pip install git+https://github.com/zhiyiYo/PyQt-Fluent-Widgets.git --no-cache-dir

      - name: 5. PyInstaller æ‰“åŒ…
        run: |
          pyinstaller \
            --name "OCCM_${{ env.TAG_NAME }}" \
            --onedir \
            --windowed \
            --noconsole \
            --hidden-import=qfluentwidgets \
            --hidden-import=qfluentwidgets.widgets \
            --hidden-import=qfluentwidgets.components \
            --hidden-import=qfluentwidgets.common \
            --exclude-module PyQt5.QtBluetooth \
            --exclude-module PyQt5.QtNfc \
            --exclude-module PyQt5.QtPositioning \
            --exclude-module PyQt5.QtGamepad \
            --collect-all PyQt5 \
            --collect-all qfluentwidgets \
            --noconfirm \
            --strip \
            --add-data "assets:assets" \
            opencode_config_manager_fluent.py
        shell: /bin/bash -e {0}

      - name: 6. æ‰“åŒ…æˆ tar.gz
        run: |
          cd dist
          rm -f OpenCode-Config-Manager-Linux-x64.tar.gz
          tar -zcvf OpenCode-Config-Manager-Linux-x64.tar.gz OpenCode-Config-Manager/
        shell: /bin/bash -e {0}

      - name: 7. ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: dist/OpenCode-Config-Manager-Linux-x64.tar.gz

  # ==================== ç»Ÿä¸€å‘å¸ƒ ====================
  release:
    name: ğŸ“¦ å‘å¸ƒåˆ° GitHub Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: æ‹‰å–é¡¹ç›®æºç ï¼ˆè·å– RELEASE.mdï¼‰
        uses: actions/checkout@v4

      - name: ä¸‹è½½ Windows æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: ./dist

      - name: ä¸‹è½½ macOS æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: macos-build
          path: ./dist

      - name: ä¸‹è½½ Linux æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: ./dist

      - name: å‘å¸ƒåˆ° GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./dist/*.exe
            ./dist/OpenCode-Config-Manager-MacOS.dmg
            ./dist/OpenCode-Config-Manager-Linux-x64.tar.gz
          overwrite_files: true
          body_path: ./RELEASE.md
          generate_release_notes: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

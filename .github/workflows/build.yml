# ç»Ÿä¸€æ„å»ºå·¥ä½œæµ - Windows + macOS + Linux ä¸‰å¹³å°è‡ªåŠ¨æ„å»ºå‘å¸ƒ
# è§¦å‘ï¼šæ¨é€ main åˆ†æ”¯ / æ¨é€ Tag / æ‰‹åŠ¨è§¦å‘
# å‘å¸ƒï¼šä»…åœ¨æ¨é€ Tag æ—¶è‡ªåŠ¨å‘å¸ƒåˆ° GitHub Release ä½¿ç”¨ RELEASE.md ä½œä¸ºå‘å¸ƒè¯´æ˜

name: ğŸš€ è‡ªåŠ¨æ„å»ºå‘å¸ƒ (Windows + macOS + Linux)

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ==================== Windows æ„å»º ====================
  build-windows:
    name: ğŸªŸ Windows æ„å»º
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - name: 1. æ‹‰å–é¡¹ç›®æºç 
        uses: actions/checkout@v4

      - name: 2. é…ç½® Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 2.1 è¯»å–ç‰ˆæœ¬å·
        shell: pwsh
        run: |
          echo "TAG_NAME=${{ github.ref_name }}" >> $env:GITHUB_ENV

      # ======== pip ç¼“å­˜ä¼˜åŒ– (æé€Ÿ 50%+ï¼‰========
      - name: ç¼“å­˜ Python ä¾èµ–åŒ…
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: 3. å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install PyQt5 PyQt-Fluent-Widgets requests pyinstaller

      - name: 3.5 ä¸‹è½½ UPX å‹ç¼©å·¥å…·
        run: |
          Invoke-WebRequest -Uri "https://github.com/upx/upx/releases/download/v4.2.4/upx-4.2.4-win64.zip" -OutFile upx.zip
          Expand-Archive upx.zip -DestinationPath .
          Move-Item upx-4.2.4-win64\upx.exe .

      - name: 4. PyInstaller æ‰“åŒ…
        run: |
          pyinstaller `
            --name "OCCM_${{ env.TAG_NAME }}" `
            --onefile `
            --windowed `
            --noconsole `
            --upx-dir . `
            --add-data "assets;assets" `
            --add-data "locales;locales" `
            --hidden-import qfluentwidgets `
            --hidden-import qfluentwidgets.widgets `
            --hidden-import qfluentwidgets.components `
            --hidden-import qfluentwidgets.common `
            --hidden-import qfluentwidgets.window `
            --collect-data qfluentwidgets `
            --collect-submodules qfluentwidgets `
            --exclude-module torch `
            --exclude-module tensorflow `
            --exclude-module scipy `
            --exclude-module matplotlib `
            --exclude-module pandas `
            --exclude-module numpy `
            --exclude-module PIL `
            --exclude-module IPython `
            --exclude-module jedi `
            --exclude-module zmq `
            --exclude-module lxml `
            --exclude-module cryptography `
            --exclude-module pyarrow `
            --exclude-module numba `
            --exclude-module llvmlite `
            --exclude-module sqlalchemy `
            --exclude-module openpyxl `
            --exclude-module pytest `
            --exclude-module pygments `
            --exclude-module psutil `
            --icon "assets/icon.ico" `
            --noconfirm `
            --clean `
            opencode_config_manager_fluent.py

      - name: 5. é‡å‘½å exe æ–‡ä»¶
        run: |
          cd dist
          Rename-Item "OCCM_${{ env.TAG_NAME }}.exe" "OCCM_${{ env.TAG_NAME }}-Windows-x64.exe"

      - name: 6. ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: dist/OCCM_${{ env.TAG_NAME }}-Windows-x64.exe

  # ==================== macOS æ„å»º ====================
  build-macos:
    name: ğŸ macOS æ„å»º
    runs-on: macos-latest
    timeout-minutes: 40
    steps:
      - name: 1. æ‹‰å–é¡¹ç›®æºç 
        uses: actions/checkout@v4

      - name: 2. é…ç½® Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 2.1 è¯»å–ç‰ˆæœ¬å·
        run: echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_ENV

      # ======== pip ç¼“å­˜ä¼˜åŒ– (æé€Ÿ 50%+ï¼‰========
      - name: ç¼“å­˜ Python ä¾èµ–åŒ…
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: 3. å®‰è£… PyQt5 + qfluentwidgets ä¾èµ–
        run: |
          python -m pip install --upgrade pip setuptools wheel -i https://pypi.tuna.tsinghua.edu.cn/simple
          python3 -m pip install PyQt5-qt5 PyQt5-sip PyQt5 requests --force-reinstall -i https://pypi.tuna.tsinghua.edu.cn/simple
          python3 -m pip install pyinstaller -i https://pypi.tuna.tsinghua.edu.cn/simple
          # macOS ARM64 æ²¡æœ‰ qfluentwidgets é¢„ç¼–è¯‘åŒ… ä» GitHub æºç å®‰è£…
          python3 -m pip install git+https://github.com/zhiyiYo/PyQt-Fluent-Widgets.git --no-cache-dir

      - name: 4. PyInstaller æ‰“åŒ…
        run: |
          pyinstaller \
            --name "OCCM_${{ env.TAG_NAME }}" \
            --onedir \
            --windowed \
            --noconsole \
            --add-data "assets:assets" \
            --add-data "locales:locales" \
            --icon "assets/icon.icns" \
            --hidden-import=qfluentwidgets \
            --hidden-import=qfluentwidgets.widgets \
            --hidden-import=qfluentwidgets.components \
            --hidden-import=qfluentwidgets.common \
            --hidden-import=qfluentwidgets.window \
            --collect-data qfluentwidgets \
            --collect-data PyQt5 \
            --exclude-module PyQt5.QtBluetooth \
            --exclude-module PyQt5.QtNfc \
            --exclude-module PyQt5.QtPositioning \
            --exclude-module PyQt5.QtGamepad \
            --noconfirm \
            --strip \
            opencode_config_manager_fluent.py
        shell: /bin/bash -e {0}
        env:
          pythonLocation: /Users/runner/hostedtoolcache/Python/3.11.11/arm64
          PKG_CONFIG_PATH: /Users/runner/hostedtoolcache/Python/3.11.11/arm64/lib/pkgconfig
          Python_ROOT_DIR: /Users/runner/hostedtoolcache/Python/3.11.11/arm64
          Python2_ROOT_DIR: /Users/runner/hostedtoolcache/Python/3.11.11/arm64
          Python3_ROOT_DIR: /Users/runner/hostedtoolcache/Python/3.11.11/arm64

      - name: 5. æ¸…ç†æ‰©å±•å±æ€§ + ç­¾å .app åŒ… (ä½¿ç”¨ entitlements)
        run: |
          # æ¸…ç† macOS æ‰©å±•å±æ€§ å½»åº•è§£å†³ã€Œæ–‡ä»¶å·²æŸåã€è­¦å‘Š
          xattr -cr dist/OCCM_${{ env.TAG_NAME }}.app
          # ä½¿ç”¨ entitlements.plist è¿›è¡Œç­¾å (æ”¯æŒ macOS 15.5 + M4 èŠ¯ç‰‡)
          codesign --force --deep --sign - --entitlements entitlements.plist dist/OCCM_${{ env.TAG_NAME }}.app
          # éªŒè¯ç­¾åæ˜¯å¦æˆåŠŸ
          codesign -vvv dist/OCCM_${{ env.TAG_NAME }}.app
        shell: /bin/bash -e {0}

      - name: 6. æ‰“åŒ… DMG é•œåƒ (åŒ…å«è‡ªåŠ¨å®‰è£…è„šæœ¬)
        run: |
          # å®‰è£… create-dmg å·²å­˜åœ¨åˆ™è·³è¿‡
          brew install create-dmg || true
          
          # åˆ›å»º DMG å†…å®¹ç›®å½•
          mkdir -p dmg_contents
          
          # å¤åˆ¶ .app
          cp -R "dist/OCCM_${{ env.TAG_NAME }}.app" dmg_contents/
          
          # åˆ›å»ºå®‰è£…è„šæœ¬å¯åŠ¨å™¨
          cat > dmg_contents/å®‰è£….command << 'EOFINSTALL'
          #!/bin/bash
          cd "$(dirname "$0")"
          ./install_update.sh
          EOFINSTALL
          chmod +x dmg_contents/å®‰è£….command
          
          # å¤åˆ¶å®‰è£…è„šæœ¬
          cp install_update.sh dmg_contents/
          chmod +x dmg_contents/install_update.sh
          
          # å¤åˆ¶è¯Šæ–­è„šæœ¬
          cp diagnose_macos.sh dmg_contents/
          chmod +x dmg_contents/diagnose_macos.sh
          
          # åˆ›å»º README
          cat > dmg_contents/README.txt << 'EOFREADME'
          OCCM - OpenCode Config Manager
          
          å®‰è£…æ–¹æ³•:
          1. åŒå‡»"å®‰è£….command"è‡ªåŠ¨å®‰è£… (æ¨è)
          2. æˆ–æ‰‹åŠ¨æ‹–æ‹½ OCCM.app åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
          
          å¦‚æœé‡åˆ°"åº”ç”¨å·²æŸå"æˆ–æ— æ³•å¯åŠ¨:
          1. æ‰“å¼€ç»ˆç«¯
          2. è¿è¡Œ: xattr -cr /Applications/OCCM.app
          3. é‡æ–°å¯åŠ¨åº”ç”¨
          
          è¯Šæ–­å·¥å…·:
          - åŒå‡» diagnose_macos.sh è¿è¡Œè¯Šæ–­
          
          æ›´å¤šå¸®åŠ©: https://github.com/icysaintdx/OpenCode-Config-Manager
          EOFREADME
          
          # åˆ é™¤æ—§çš„ dmg åŒ… é¿å…å†²çª
          rm -rf dist/OCCM_${{ env.TAG_NAME }}.dmg
          
          # ç”Ÿæˆ Mac æ ‡å‡†å¸¦æ‹–æ‹½å¼•å¯¼çš„ DMG é•œåƒ
          create-dmg \
            --volname "OCCM ${{ env.TAG_NAME }}" \
            --window-size 800 500 \
            --icon-size 100 \
            --icon "OCCM_${{ env.TAG_NAME }}.app" 200 200 \
            --app-drop-link 600 200 \
            --hide-extension "OCCM_${{ env.TAG_NAME }}.app" \
            --volicon "assets/icon.icns" \
            --no-internet-enable \
            "dist/OCCM_${{ env.TAG_NAME }}.dmg" \
            "dmg_contents/"
        shell: /bin/bash -e {0}

      - name: 7. ç­¾å DMG æ–‡ä»¶ (ä¿®å¤ç­¾åå¤±æ•ˆé—®é¢˜)
        run: |
          # ç­¾å DMG æ–‡ä»¶æœ¬èº« é˜²æ­¢ create-dmg ç ´åç­¾å
          codesign --force --sign - "dist/OCCM_${{ env.TAG_NAME }}.dmg"
          # éªŒè¯ DMG ç­¾å
          codesign -vvv "dist/OCCM_${{ env.TAG_NAME }}.dmg" || echo "DMG ç­¾åéªŒè¯å®Œæˆ"
        shell: /bin/bash -e {0}

      - name: 8. æ‰“åŒ… ZIP ç‰ˆæœ¬ (è§£å‹å³ç”¨)
        run: |
          cd dist
          # æ‰“åŒ… .app ä¸º zip æ–¹ä¾¿ç”¨æˆ·ç›´æ¥è§£å‹ä½¿ç”¨
          zip -r "OCCM_${{ env.TAG_NAME }}-macOS.zip" "OCCM_${{ env.TAG_NAME }}.app"
        shell: /bin/bash -e {0}

      - name: 9. ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            dist/OCCM_${{ env.TAG_NAME }}.dmg
            dist/OCCM_${{ env.TAG_NAME }}-macOS.zip

  # ==================== Linux æ„å»º ====================
  build-linux:
    name: ğŸ§ Linux æ„å»º
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
      - name: 1. æ‹‰å–é¡¹ç›®æºç 
        uses: actions/checkout@v4

      - name: 2. é…ç½® Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          architecture: x64

      - name: 2.1 è¯»å–ç‰ˆæœ¬å·
        run: echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_ENV

      # ======== pip ç¼“å­˜ä¼˜åŒ– (æé€Ÿ 50%+ï¼‰========
      - name: ç¼“å­˜ Python ä¾èµ–åŒ…
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: 3. å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt update -y && sudo apt install -y \
            python3-pyqt5 \
            libxcb-xinerama0 \
            libxcb-cursor0 \
            libgl1 \
            libglib2.0-0 \
            libxkbcommon-x11-0 \
            python3-dev \
            build-essential \
            pyqt5-dev-tools \
            git \
            libxcb-randr0-dev libxcb-xtest0-dev \
            fuse libfuse2 \
            file

      - name: 4. å®‰è£… Python ä¾èµ–
        run: |
          python3 -m pip install --upgrade pip setuptools wheel -i https://pypi.tuna.tsinghua.edu.cn/simple
          python3 -m pip install pyinstaller PyQt5==5.15.10 requests --force-reinstall --no-cache-dir -i https://pypi.tuna.tsinghua.edu.cn/simple
          python3 -m pip install git+https://github.com/zhiyiYo/PyQt-Fluent-Widgets.git --no-cache-dir

      - name: 5. PyInstaller æ‰“åŒ…
        run: |
          pyinstaller \
            --name "OCCM_${{ env.TAG_NAME }}" \
            --onedir \
            --windowed \
            --noconsole \
            --hidden-import=qfluentwidgets \
            --hidden-import=qfluentwidgets.widgets \
            --hidden-import=qfluentwidgets.components \
            --hidden-import=qfluentwidgets.common \
            --hidden-import=qfluentwidgets.window \
            --collect-data qfluentwidgets \
            --collect-data PyQt5 \
            --exclude-module PyQt5.QtBluetooth \
            --exclude-module PyQt5.QtNfc \
            --exclude-module PyQt5.QtPositioning \
            --exclude-module PyQt5.QtGamepad \
            --noconfirm \
            --strip \
            --add-data "assets:assets" \
            --add-data "locales:locales" \
            opencode_config_manager_fluent.py
        shell: /bin/bash -e {0}

      - name: 6. æ‰“åŒ…æˆ tar.gz
        run: |
          cd dist
          rm -f OCCM_${{ env.TAG_NAME }}-Linux-x64.tar.gz
          tar -zcvf OCCM_${{ env.TAG_NAME }}-Linux-x64.tar.gz OCCM_${{ env.TAG_NAME }}/
        shell: /bin/bash -e {0}

      - name: 7. åˆ›å»º AppImage (å•æ–‡ä»¶å¯æ‰§è¡Œ)
        run: |
          # ä¸‹è½½ appimagetool
          wget -q "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage" -O appimagetool
          chmod +x appimagetool
          
          # åˆ›å»º AppDir ç»“æ„
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          
          # å¤åˆ¶åº”ç”¨æ–‡ä»¶
          cp -r dist/OCCM_${{ env.TAG_NAME }}/* AppDir/usr/bin/
          
          # åˆ›å»ºå¯åŠ¨è„šæœ¬
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/bin:${LD_LIBRARY_PATH}"
          # ä½¿ç”¨é€šé…ç¬¦åŒ¹é…å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆé¿å…ç¡¬ç¼–ç ç‰ˆæœ¬å·ï¼‰
          exec "${HERE}/usr/bin/"OCCM_* "$@"
          EOF
          chmod +x AppDir/AppRun
          
          # åˆ›å»º .desktop æ–‡ä»¶
          cat > AppDir/OCCM.desktop << EOF
          [Desktop Entry]
          Type=Application
          Name=OCCM
          Comment=OpenCode Config Manager
          Exec=OCCM_${{ env.TAG_NAME }}
          Icon=occm
          Categories=Development;Utility;
          Terminal=false
          EOF
          cp AppDir/OCCM.desktop AppDir/usr/share/applications/
          
          # å¤åˆ¶å›¾æ ‡ (å¦‚æœå­˜åœ¨)
          if [ -f "assets/icon.png" ]; then
            cp assets/icon.png AppDir/usr/share/icons/hicolor/256x256/apps/occm.png
            cp assets/icon.png AppDir/occm.png
          else
            # åˆ›å»ºä¸€ä¸ªç®€å•çš„å ä½å›¾æ ‡
            echo "No icon found, using placeholder"
            touch AppDir/occm.png
          fi
          
          # æ‰“åŒ… AppImage
          ARCH=x86_64 ./appimagetool AppDir "dist/OCCM_${{ env.TAG_NAME }}-Linux-x86_64.AppImage"
        shell: /bin/bash -e {0}

      - name: 8. åˆ›å»º DEB åŒ… (Debian/Ubuntu)
        run: |
          # å®‰è£… fpm
          sudo gem install fpm
          
          # åˆ›å»ºç¬¦å·é“¾æ¥è„šæœ¬ (å®‰è£…åæ‰§è¡Œ)
          cat > postinst << 'EOFPOSTINST'
          #!/bin/bash
          # åˆ›å»ºç¬¦å·é“¾æ¥åˆ° /usr/local/bin
          ln -sf /opt/occm/OCCM_* /usr/local/bin/occm
          EOFPOSTINST
          chmod +x postinst
          
          # åˆ›å»º deb åŒ…
          fpm -s dir -t deb \
            --name occm \
            --version "${{ env.TAG_NAME }}" \
            --description "OpenCode Config Manager - å¯è§†åŒ–ç®¡ç† OpenCode é…ç½®" \
            --maintainer "IcySaint <icysaintdx@github.com>" \
            --url "https://github.com/icysaintdx/OpenCode-Config-Manager" \
            --license "MIT" \
            --architecture amd64 \
            --depends "libxcb-xinerama0" \
            --depends "libxcb-cursor0" \
            --depends "libxcb-randr0" \
            --depends "libxcb-xtest0" \
            --depends "libxcb-shape0" \
            --depends "libxcb-xfixes0" \
            --depends "libgl1" \
            --depends "libglib2.0-0" \
            --depends "libxkbcommon-x11-0" \
            --depends "libfontconfig1" \
            --depends "libfreetype6" \
            --after-install postinst \
            --package "dist/OCCM_${{ env.TAG_NAME }}-Linux-amd64.deb" \
            "dist/OCCM_${{ env.TAG_NAME }}/=/opt/occm" \
            "AppDir/OCCM.desktop=/usr/share/applications/occm.desktop"
        shell: /bin/bash -e {0}

      - name: 9. ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            dist/OCCM_${{ env.TAG_NAME }}-Linux-x64.tar.gz
            dist/OCCM_${{ env.TAG_NAME }}-Linux-x86_64.AppImage
            dist/OCCM_${{ env.TAG_NAME }}-Linux-amd64.deb

  # ==================== ç»Ÿä¸€å‘å¸ƒ ====================
  release:
    name: ğŸ“¦ å‘å¸ƒåˆ° GitHub Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: æ‹‰å–é¡¹ç›®æºç  (è·å– RELEASE.mdï¼‰
        uses: actions/checkout@v4

      - name: ä¸‹è½½ Windows æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: ./dist

      - name: ä¸‹è½½ macOS æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: macos-build
          path: ./dist

      - name: ä¸‹è½½ Linux æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: ./dist

      - name: åˆ—å‡ºæ‰€æœ‰æ„å»ºäº§ç‰©
        run: ls -la ./dist/

      - name: å‘å¸ƒåˆ° GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./dist/*.exe
            ./dist/*.dmg
            ./dist/*.zip
            ./dist/*-Linux-x64.tar.gz
            ./dist/*.AppImage
            ./dist/*.deb
          overwrite_files: true
          body_path: ./RELEASE.md
          generate_release_notes: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

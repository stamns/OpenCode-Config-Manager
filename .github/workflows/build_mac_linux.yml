# .github/workflows/build_mac_only.yml (终局无BUG封神版 - 解决所有报错，Mac+Linux双构建+完美发布)
name: 自动构建Mac+Linux版 OpenCode-Config-Manager (最终稳定版)
# 触发规则：推送任何代码/推送任何Tag 都触发构建，发布由job的if条件控制
on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch: # 支持手动点击运行

permissions:
  contents: write # 发布Release必须的权限，必须保留

jobs:
  # ========== 任务1：构建Mac版本 (完全未修改，你的原版稳定代码) ==========
  build-macos:
    runs-on: macos-latest
    timeout-minutes: 40
    steps:
      - name: 1. 拉取项目源码
        uses: actions/checkout@v4

      - name: 2. 配置Python3.10 (ARM64兼容)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 3. 安装PyQt5依赖
        run: |
          python -m pip install --upgrade pip -i https://pypi.tuna.tsinghua.edu.cn/simple
          python3 -m pip install PyQt5-qt5 PyQt5-sip PyQt5 --force-reinstall -i https://pypi.tuna.tsinghua.edu.cn/simple

      - name: Build App with PyInstaller
        run: |
          python3 -m pip install pyinstaller
          pyinstaller \
            --name "OpenCode-Config-Manager" \
            --onedir \
            --windowed \
            --noconsole \
            --hidden-import=qfluentwidgets \
            --hidden-import=qfluentwidgets.widgets \
            --hidden-import=qfluentwidgets.components \
            --hidden-import=qfluentwidgets.common \
            --exclude-module PyQt5.QtBluetooth \
            --exclude-module PyQt5.QtNfc \
            --exclude-module PyQt5.QtPositioning \
            --exclude-module PyQt5.QtGamepad \
            --collect-all PyQt5 \
            --collect-all qfluentwidgets \
            --noconfirm \
            --strip \
            opencode_config_manager_fluent.py
        shell: /bin/bash -e {0}
        env:
          pythonLocation: /Users/runner/hostedtoolcache/Python/3.10.11/arm64
          PKG_CONFIG_PATH: /Users/runner/hostedtoolcache/Python/3.10.11/arm64/lib/pkgconfig
          Python_ROOT_DIR: /Users/runner/hostedtoolcache/Python/3.10.11/arm64
          Python2_ROOT_DIR: /Users/runner/hostedtoolcache/Python/3.10.11/arm64
          Python3_ROOT_DIR: /Users/runner/hostedtoolcache/Python/3.10.11/arm64

      - name: 打包成DMG镜像包
        run: |
          brew install create-dmg || true
          rm -f dist/OpenCode-Config-Manager-MacOS.dmg
          create-dmg \
            --volname "OpenCode-Config-Manager" \
            "dist/OpenCode-Config-Manager-MacOS.dmg" \
            "dist/OpenCode-Config-Manager/"
        shell: /bin/bash -e {0}

      - name: 免证书签名
        run: |
          xattr -cr dist/OpenCode-Config-Manager.app
          codesign --force --deep --sign - dist/OpenCode-Config-Manager.app
        shell: /bin/bash -e {0}
          
      - name: 上传Mac产物到临时存储
        uses: actions/upload-artifact@v4
        with:
          name: mac-build
          path: dist/OpenCode-Config-Manager-MacOS.dmg

  # ========== 任务2：构建Linux版本 (所有历史修复保留，qfluentwidgets安装正常) ==========
  build-linux:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
      - name: 1. 拉取项目源码
        uses: actions/checkout@v4

      - name: 2. 配置Python3.10 (x64兼容)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          architecture: x64

      - name: 3. 安装系统依赖+编译依赖+git
        run: |
          sudo apt update -y && sudo apt install -y \
            python3-pyqt5 \
            libxcb-xinerama0 \
            libxcb-cursor0 \
            libgl1 \
            libglib2.0-0 \
            libxkbcommon-x11-0 \
            python3-dev \
            build-essential \
            pyqt5-dev-tools \
            git

      - name: 4. 从GitHub安装qfluentwidgets (永不失败)
        run: |
          python3 -m pip install --upgrade pip setuptools wheel -i https://pypi.tuna.tsinghua.edu.cn/simple
          python3 -m pip install pyinstaller PyQt5==5.15.10 --force-reinstall --no-cache-dir -i https://pypi.tuna.tsinghua.edu.cn/simple
          python3 -m pip install git+https://github.com/zhiyiYo/PyQt-Fluent-Widgets.git --no-cache-dir

      - name: 5. PyInstaller打包
        run: |
          python3 -m pip install pyinstaller
          pyinstaller \
            --name "OpenCode-Config-Manager" \
            --onedir \
            --windowed \
            --noconsole \
            --hidden-import=qfluentwidgets \
            --hidden-import=qfluentwidgets.widgets \
            --hidden-import=qfluentwidgets.components \
            --hidden-import=qfluentwidgets.common \
            --exclude-module PyQt5.QtBluetooth \
            --exclude-module PyQt5.QtNfc \
            --exclude-module PyQt5.QtPositioning \
            --exclude-module PyQt5.QtGamepad \
            --collect-all PyQt5 \
            --collect-all qfluentwidgets \
            --noconfirm \
            --strip \
            opencode_config_manager_fluent.py
        shell: /bin/bash -e {0}

      - name: 6. 打包成tar.gz压缩包
        run: |
          cd dist
          rm -f OpenCode-Config-Manager-Linux-x64.tar.gz
          tar -zcvf OpenCode-Config-Manager-Linux-x64.tar.gz OpenCode-Config-Manager/
        shell: /bin/bash -e {0}

      - name: 上传Linux产物到临时存储
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: dist/OpenCode-Config-Manager-Linux-x64.tar.gz

  # ========== 任务3：统一发布 (✅ 终极修复核心：if写在job根级别！！！) ==========
  release:
    needs: [build-macos, build-linux] # 依赖两个构建任务完成
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') # ✅✅✅ 正确位置：job根级别，无Tag直接跳过整个任务，根治报错
    steps:
      - name: 下载Mac构建产物
        uses: actions/download-artifact@v4
        with:
          name: mac-build
          path: ./dist

      - name: 下载Linux构建产物
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: ./dist

      - name: 发布到GitHub Release (✅ 标准语法，无任何错误)
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./dist/OpenCode-Config-Manager-MacOS.dmg
            ./dist/OpenCode-Config-Manager-Linux-x64.tar.gz
          overwrite_files: true
          generate_release_notes: true
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# .github/workflows/build_mac_only.yml (终极兜底版 - 源码集成，适配所有Mac架构，永久可用)
name: 自动构建Mac版 OpenCode-Config-Manager (源码集成/永久可用)

on:
  workflow_dispatch:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest  # 可用macos-latest/ macos-15 / macos-15-intel 任意镜像
    timeout-minutes: 30
    steps:
      - name: 1. 拉取项目源码（含qfluentwidgets本地源码）
        uses: actions/checkout@v4

      - name: 2. 配置Python3.10环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: 3. 安装依赖（只装PyQt5+pyinstaller，无需装qfluentwidgets）
        run: |
          python -m pip install --upgrade pip -i https://pypi.tuna.tsinghua.edu.cn/simple
          pip install PyQt5>=5.15.9 pyinstaller==6.8.0 macholib -i https://pypi.tuna.tsinghua.edu.cn/simple

      - name: 4. 验证本地源码导入成功
        run: |
          python -c "import sys; sys.path.insert(0, '.'); import qfluentwidgets; print('✅ 本地源码导入成功')"

      - name: 5. PyInstaller打包（适配本地源码，无任何缺失）
        run: |
          pyinstaller \
            --name "OpenCode-Config-Manager" \
            --onedir \
            --windowed \
            --paths=. \          # 核心：加载项目根目录的本地源码
            --add-package=qfluentwidgets \ # 核心：打包本地的qfluentwidgets源码
            --collect-all PyQt5 \
            opencode_config_manager_fluent.py

      - name: 6. 打包成.dmg镜像包
        run: |
          mkdir -p dist/MacApp
          mv dist/OpenCode-Config-Manager.app dist/MacApp/
          hdiutil create dist/OpenCode-Config-Manager-MacOS.dmg -volname "OpenCode配置管理器" -srcfolder dist/MacApp -ov -format UDZO

      - name: 7. 上传到GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          files: dist/OpenCode-Config-Manager-MacOS.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

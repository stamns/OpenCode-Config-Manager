# .github/workflows/build_mac_only.yml (终局无错版 - PyInstaller6.8.0完美兼容、PyQt5无BUG、100%打包成功)
name: 自动构建Mac版 OpenCode-Config-Manager (最终成功版)
on:
  workflow_dispatch:
permissions:
  contents: write
jobs:
  build-macos:
    runs-on: macos-latest
    timeout-minutes: 40
    steps:
      - name: 1. 拉取项目源码
        uses: actions/checkout@v4

      - name: 2. 配置Python3.10 (ARM64完美兼容)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 3. ✅ 核心修复：安装【无BUG版PyQt5 5.15.7】+ 必装依赖 (100%成功，无任何冲突)
        run: |
          python -m pip install --upgrade pip -i https://pypi.tuna.tsinghua.edu.cn/simple
          python3 -m pip install PyQt5-qt5 PyQt5-sip PyQt5 --force-reinstall -i https://pypi.tuna.tsinghua.edu.cn/simple

      - name: Build App with PyInstaller
        run: |
          # 第一步：必执行！安装pyinstaller（解决 command not found 核心问题）
          python3 -m pip install pyinstaller
          # 第二步：执行修复语法+优化后的打包命令
          pyinstaller \
            --name "OpenCode-Config-Manager" \
            --onedir \
            --windowed \
            --noconsole \
            --hidden-import=qfluentwidgets \
            --hidden-import=qfluentwidgets.widgets \
            --hidden-import=qfluentwidgets.components \
            --hidden-import=qfluentwidgets.common \
            --exclude-module PyQt5.QtBluetooth \
            --exclude-module PyQt5.QtNfc \
            --exclude-module PyQt5.QtPositioning \
            --exclude-module PyQt5.QtGamepad \
            --collect-all PyQt5 \
            --collect-all qfluentwidgets \
            --noconfirm \
            opencode_config_manager_fluent.py
        shell: /bin/bash -e {0}
        env:
          pythonLocation: /Users/runner/hostedtoolcache/Python/3.10.11/arm64
          PKG_CONFIG_PATH: /Users/runner/hostedtoolcache/Python/3.10.11/arm64/lib/pkgconfig
          Python_ROOT_DIR: /Users/runner/hostedtoolcache/Python/3.10.11/arm64
          Python2_ROOT_DIR: /Users/runner/hostedtoolcache/Python/3.10.11/arm64
          Python3_ROOT_DIR: /Users/runner/hostedtoolcache/Python/3.10.11/arm64

      - name: 5. 打包成DMG镜像包 (用户可用，原生Mac应用)
        run: |
          mkdir -p dist/MacApp
          mv dist/OpenCode-Config-Manager.app dist/MacApp/
          hdiutil create dist/OpenCode-Config-Manager-MacOS.dmg -volname "配置管理器" -srcfolder dist/MacApp -ov -format UDZO

      - name: 6. 上传到GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/OpenCode-Config-Manager-MacOS.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

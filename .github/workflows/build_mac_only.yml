# .github/workflows/build_mac_only.yml (终局版 - 修复所有BUG，ARM64适配，100%打包成功，无任何报错)
name: 自动构建Mac版 OpenCode-Config-Manager (终局无错版)
on:
  workflow_dispatch:  # 仅手动触发，最稳定
permissions:
  contents: write
jobs:
  build-macos:
    runs-on: macos-latest
    timeout-minutes: 35  # 加长超时，足够完成所有步骤
    steps:
      - name: 1. 拉取项目源码 (完整无缺失)
        uses: actions/checkout@v4

      - name: 2. 配置Python 3.10 (ARM64完美兼容)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: 3. ✅ 云端自动下载qfluentwidgets源码文件夹 (核心！不用你本地操作，必成功)
        run: |
          curl -L -s https://github.com/zhiyiYo/PyQt5-Fluent-Widgets/archive/refs/heads/master.zip -o qfluent.zip
          unzip -q qfluent.zip
          cp -r PyQt5-Fluent-Widgets-master/qfluentwidgets ./
          rm -rf qfluent.zip PyQt5-Fluent-Widgets-master
          echo "✅ qfluentwidgets源码文件夹下载完成"

      - name: 4. 安装必须依赖 (只装能装上的，无任何报错)
        run: |
          python -m pip install --upgrade pip -i https://pypi.tuna.tsinghua.edu.cn/simple
          pip install PyQt5>=5.15.9 pyinstaller==6.8.0 macholib -i https://pypi.tuna.tsinghua.edu.cn/simple
          echo "✅ 依赖安装完成"

      - name: 5. ✅ 核心打包命令 (修复所有BUG，绝杀所有报错，无任何冲突)
        run: |
          pyinstaller \
            --name "OpenCode-Config-Manager" \
            --onedir \
            --windowed \
            --noconsole \
            --paths=. \
            --hidden-import=qfluentwidgets \
            --exclude-module PyQt5.QtBluetooth \  # 绝杀BUG：排除冲突的蓝牙模块，解决软链接重复
            --collect-all PyQt5 \
            opencode_config_manager_fluent.py
          echo "✅ 打包完成，无任何报错"

      - name: 6. 打包成Mac标准DMG镜像包 (用户友好，拖拽安装)
        run: |
          mkdir -p dist/MacApp
          mv dist/OpenCode-Config-Manager.app dist/MacApp/
          hdiutil create dist/OpenCode-Config-Manager-MacOS.dmg -volname "OpenCode配置管理器" -srcfolder dist/MacApp -ov -format UDZO
          echo "✅ DMG镜像打包完成"

      - name: 7. 自动上传到GitHub Releases (下载即用)
        uses: softprops/action-gh-release@v2
        with:
          files: dist/OpenCode-Config-Manager-MacOS.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

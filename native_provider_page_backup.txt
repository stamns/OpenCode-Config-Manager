class NativeProviderPage(BasePage):
    """原生 Provider 配置页面 - 管理 OpenCode 官方支持的原生 AI 服务提供商"""

    def __init__(self, main_window, parent=None):
        super().__init__("原生 Provider", parent)
        self.main_window = main_window
        self.auth_manager = AuthManager()
        self.env_detector = EnvVarDetector()
        self._setup_ui()
        self._load_data()
        # 连接配置变更信号
        self.main_window.config_changed.connect(self._on_config_changed)

    def _on_config_changed(self):
        """配置变更时刷新列表"""
        self._load_data()

    def _setup_ui(self):
        """初始化 UI 布局"""
        # 工具栏
        toolbar = QHBoxLayout()

        self.config_btn = PrimaryPushButton(FIF.SETTING, "配置 Provider", self)
        self.config_btn.clicked.connect(self._on_config)
        toolbar.addWidget(self.config_btn)

        self.test_btn = PushButton(FIF.WIFI, "测试连接", self)
        self.test_btn.clicked.connect(self._on_test)
        toolbar.addWidget(self.test_btn)

        self.delete_btn = PushButton(FIF.DELETE, "删除配置", self)
        self.delete_btn.clicked.connect(self._on_delete)
        toolbar.addWidget(self.delete_btn)

        toolbar.addStretch()
        self._layout.addLayout(toolbar)

        # Provider 列表表格
        self.table = TableWidget(self)
        self.table.setColumnCount(4)
        self.table.setHorizontalHeaderLabels(["Provider", "SDK", "状态", "环境变量"])

        header = self.table.horizontalHeader()
        header.setSectionResizeMode(0, QHeaderView.Fixed)
        header.resizeSection(0, 160)
        header.setSectionResizeMode(1, QHeaderView.Stretch)
        header.setSectionResizeMode(2, QHeaderView.Fixed)
        header.resizeSection(2, 80)
        header.setSectionResizeMode(3, QHeaderView.Stretch)

        self.table.setSelectionBehavior(QAbstractItemView.SelectRows)
        self.table.setSelectionMode(QAbstractItemView.SingleSelection)
        self.table.setEditTriggers(QAbstractItemView.NoEditTriggers)
        self.table.doubleClicked.connect(self._on_config)
        self._layout.addWidget(self.table)

    def _load_data(self):
        """加载 Provider 数据"""
        self.table.setRowCount(0)

        # 读取已配置的认证
        auth_data = {}
        try:
            auth_data = self.auth_manager.read_auth()
        except Exception:
            pass

        for provider in NATIVE_PROVIDERS:
            row = self.table.rowCount()
            self.table.insertRow(row)

            # Provider 名称
            name_item = QTableWidgetItem(provider.name)
            name_item.setData(Qt.UserRole, provider.id)
            self.table.setItem(row, 0, name_item)

            # SDK
            self.table.setItem(row, 1, QTableWidgetItem(provider.sdk))

            # 状态
            is_configured = provider.id in auth_data and auth_data[provider.id]
            status_text = "已配置" if is_configured else "未配置"
            status_item = QTableWidgetItem(status_text)
            if is_configured:
                status_item.setForeground(QColor("#4CAF50"))
            else:
                status_item.setForeground(QColor("#9E9E9E"))
            self.table.setItem(row, 2, status_item)

            # 环境变量
            env_vars = ", ".join(provider.env_vars) if provider.env_vars else "-"
            env_item = QTableWidgetItem(env_vars)
            env_item.setToolTip(env_vars)
            self.table.setItem(row, 3, env_item)

    def _get_selected_provider(self) -> Optional[NativeProviderConfig]:
        """获取当前选中的 Provider"""
        row = self.table.currentRow()
        if row < 0:
            return None
        provider_id = self.table.item(row, 0).data(Qt.UserRole)
        return get_native_provider(provider_id)

    def _on_config(self):
        """配置 Provider"""
        provider = self._get_selected_provider()
        if not provider:
            self.show_warning("提示", "请先选择一个 Provider")
            return

        dialog = NativeProviderDialog(
            self.main_window,
            provider,
            self.auth_manager,
            self.env_detector,
            parent=self,
        )
        if dialog.exec_():
            self._load_data()
            self.show_success("成功", f"{provider.name} 配置已保存")

    def _on_test(self):
        """测试连接"""
        provider = self._get_selected_provider()
        if not provider:
            self.show_warning("提示", "请先选择一个 Provider")
            return

        if not provider.test_endpoint:
            self.show_warning("提示", "此 Provider 不支持连接测试")
            return

        # 获取认证信息
        auth_data = self.auth_manager.get_provider_auth(provider.id)
        if not auth_data:
            self.show_error("测试失败", "请先配置此 Provider")
            return

        api_key = auth_data.get("apiKey", "")
        if api_key:
            api_key = _resolve_env_value(api_key)

        if not api_key:
            self.show_error("测试失败", "未找到 API Key")
            return

        # 获取 baseURL
        config = self.main_window.opencode_config or {}
        provider_options = (
            config.get("provider", {}).get(provider.id, {}).get("options", {})
        )
        base_url = provider_options.get("baseURL", "")

        if not base_url:
            default_urls = {
                "anthropic": "https://api.anthropic.com",
                "openai": "https://api.openai.com",
                "gemini": "https://generativelanguage.googleapis.com",
                "xai": "https://api.x.ai",
                "groq": "https://api.groq.com",
                "openrouter": "https://openrouter.ai/api",
                "deepseek": "https://api.deepseek.com",
                "opencode": "https://api.opencode.ai",
            }
            base_url = default_urls.get(provider.id, "")

        if not base_url:
            self.show_error("测试失败", "无法确定 API 地址")
            return

        test_url = base_url.rstrip("/") + provider.test_endpoint

        # 执行测试
        self.show_warning("测试中", "正在测试连接...")

        start_time = time.time()
        try:
            req = urllib.request.Request(test_url)
            req.add_header("Authorization", f"Bearer {api_key}")
            req.add_header("x-api-key", api_key)
            with urllib.request.urlopen(req, timeout=10) as resp:
                elapsed = int((time.time() - start_time) * 1000)
                self.show_success("连接成功", f"响应时间: {elapsed}ms")
        except urllib.error.HTTPError as e:
            self.show_error("连接失败", f"HTTP {e.code}: {e.reason}")
        except Exception as e:
            self.show_error("连接失败", str(e))

    def _on_delete(self):
        """删除配置"""
        provider = self._get_selected_provider()
        if not provider:
            self.show_warning("提示", "请先选择一个 Provider")
            return

        # 检查是否已配置
        auth_data = self.auth_manager.get_provider_auth(provider.id)
        if not auth_data:
            self.show_warning("提示", "此 Provider 尚未配置")
            return

        # 确认删除
        msg_box = FluentMessageBox(
            "确认删除",
            f"确定要删除 {provider.name} 的配置吗？\n这将删除认证信息和选项配置。",
            self,
        )
        if msg_box.exec_() != QMessageBox.Yes:
            return

        # 删除认证
        try:
            self.auth_manager.delete_provider_auth(provider.id)
        except Exception as e:
            self.show_error("删除失败", f"无法删除认证配置: {e}")
            return

        # 删除选项
        config = self.main_window.opencode_config or {}
        if "provider" in config and provider.id in config["provider"]:
            if "options" in config["provider"][provider.id]:
                del config["provider"][provider.id]["options"]
                if not config["provider"][provider.id]:
                    del config["provider"][provider.id]
                self.main_window.opencode_config = config
                self.main_window.save_opencode_config()

        self.show_success("删除成功", f"{provider.name} 配置已删除")
        self._load_data()


class NativeProviderDialog(QDialog):
    """原生 Provider 配置对话框"""

    def __init__(
        self,
        main_window,
        provider: NativeProviderConfig,
        auth_manager: AuthManager,
        env_detector: EnvVarDetector,
        parent=None,
    ):
        super().__init__(parent)
        self.main_window = main_window
        self.provider = provider
        self.auth_manager = auth_manager
        self.env_detector = env_detector
        self.auth_inputs: Dict[str, QWidget] = {}
        self.option_inputs: Dict[str, QWidget] = {}
        self._setup_ui()

    def _setup_ui(self):
        """初始化对话框 UI"""
        self.setWindowTitle(f"配置 {self.provider.name}")
        self.setMinimumWidth(500)
        self.setMinimumHeight(400)

        # 设置深色背景样式
        self.setStyleSheet("""
            QDialog {
                background-color: #2b2b2b;
            }
            QGroupBox {
                background-color: #363636;
                border: 1px solid #454545;
                border-radius: 6px;
                margin-top: 12px;
                padding-top: 10px;
                color: #e0e0e0;
                font-weight: bold;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                left: 10px;
                padding: 0 5px;
                color: #e0e0e0;
            }
        """)

        layout = QVBoxLayout(self)
        layout.setSpacing(16)

        # Provider 信息
        info_label = CaptionLabel(f"SDK: {self.provider.sdk}", self)
        layout.addWidget(info_label)

        # 环境变量检测提示
        detected_env = self.env_detector.detect_env_vars(self.provider.id)
        if detected_env:
            env_hint = CaptionLabel(
                f"✓ 检测到环境变量: {', '.join(detected_env.keys())}", self
            )
            env_hint.setStyleSheet("color: #4CAF50;")
            layout.addWidget(env_hint)

        # 认证配置卡片
        auth_card = SimpleCardWidget(self)
        auth_card_layout = QVBoxLayout(auth_card)
        auth_card_layout.setContentsMargins(16, 16, 16, 16)
        auth_card_layout.setSpacing(12)

        auth_title = StrongBodyLabel("认证配置", auth_card)
        auth_card_layout.addWidget(auth_title)

        current_auth = self.auth_manager.get_provider_auth(self.provider.id) or {}

        for field in self.provider.auth_fields:
            field_layout = QHBoxLayout()

            label = BodyLabel(
                f"{field.label}{'*' if field.required else ''}", auth_card
            )
            label.setMinimumWidth(120)
            field_layout.addWidget(label)

            if field.field_type == "password":
                input_widget = LineEdit(auth_card)
                input_widget.setEchoMode(LineEdit.Password)
            else:
                input_widget = LineEdit(auth_card)

            input_widget.setPlaceholderText(field.placeholder)
            if field.key in current_auth:
                input_widget.setText(str(current_auth[field.key]))

            field_layout.addWidget(input_widget, 1)

            # 环境变量导入按钮
            env_var = self._get_env_var_for_field(field.key)
            if env_var and env_var in detected_env:
                import_btn = ToolButton(FIF.DOWNLOAD, auth_card)
                import_btn.setToolTip(f"导入 {env_var}")
                import_btn.clicked.connect(
                    partial(self._import_env_var, input_widget, env_var)
                )
                field_layout.addWidget(import_btn)

            self.auth_inputs[field.key] = input_widget
            auth_card_layout.addLayout(field_layout)

        layout.addWidget(auth_card)

        # 选项配置卡片
        if self.provider.option_fields:
            option_card = SimpleCardWidget(self)
            option_card_layout = QVBoxLayout(option_card)
            option_card_layout.setContentsMargins(16, 16, 16, 16)
            option_card_layout.setSpacing(12)

            option_title = StrongBodyLabel("Provider 选项", option_card)
            option_card_layout.addWidget(option_title)

            config = self.main_window.opencode_config or {}
            current_options = (
                config.get("provider", {}).get(self.provider.id, {}).get("options", {})
            )

            for field in self.provider.option_fields:
                field_layout = QHBoxLayout()

                label = BodyLabel(field.label, option_card)
                label.setMinimumWidth(120)
                field_layout.addWidget(label)

                if field.field_type == "select" and field.options:
                    input_widget = ComboBox(option_card)
                    input_widget.addItems(field.options)
                    current_value = current_options.get(field.key, field.default)
                    if current_value in field.options:
                        input_widget.setCurrentText(current_value)
                else:
                    input_widget = LineEdit(option_card)
                    input_widget.setPlaceholderText(field.default or "可选")
                    input_widget.setText(str(current_options.get(field.key, "")))

                field_layout.addWidget(input_widget, 1)
                self.option_inputs[field.key] = input_widget
                option_card_layout.addLayout(field_layout)

            layout.addWidget(option_card)

        layout.addStretch()

        # 按钮
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()

        cancel_btn = PushButton("取消", self)
        cancel_btn.clicked.connect(self.reject)
        btn_layout.addWidget(cancel_btn)

        save_btn = PrimaryPushButton("保存", self)
        save_btn.clicked.connect(self._on_save)
        btn_layout.addWidget(save_btn)

        layout.addLayout(btn_layout)

    def _get_env_var_for_field(self, field_key: str) -> Optional[str]:
        """获取字段对应的环境变量名"""
        for env_var, auth_field in self.env_detector.ENV_TO_AUTH_FIELD.items():
            if auth_field == field_key:
                provider_vars = self.env_detector.PROVIDER_ENV_VARS.get(
                    self.provider.id, []
                )
                if env_var in provider_vars:
                    return env_var
        return None

    def _import_env_var(self, input_widget: LineEdit, env_var: str):
        """导入环境变量引用"""
        ref = self.env_detector.format_env_reference(env_var)
        input_widget.setText(ref)

    def _on_save(self):
        """保存配置"""
        # 检查重复
        config = self.main_window.opencode_config or {}
        custom_providers = config.get("provider", {})
        if self.provider.id in custom_providers:
            if custom_providers[self.provider.id].get("npm"):
                msg_box = FluentMessageBox(
                    "配置冲突",
                    f"已存在同名的自定义 Provider '{self.provider.id}'。\n继续保存？",
                    self,
                )
                if msg_box.exec_() != QMessageBox.Yes:
                    return

        # 收集认证数据
        auth_data = {}
        for field in self.provider.auth_fields:
            input_widget = self.auth_inputs.get(field.key)
            if input_widget:
                value = input_widget.text().strip()
                if value:
                    auth_data[field.key] = value
                elif field.required:
                    QMessageBox.warning(self, "验证失败", f"{field.label} 是必填项")
                    return

        # 保存认证
        try:
            self.auth_manager.set_provider_auth(self.provider.id, auth_data)
        except Exception as e:
            QMessageBox.critical(self, "保存失败", f"无法保存认证配置: {e}")
            return

        # 保存选项
        if self.option_inputs:
            options = {}
            for field in self.provider.option_fields:
                input_widget = self.option_inputs.get(field.key)
                if input_widget:
                    if isinstance(input_widget, ComboBox):
                        value = input_widget.currentText()
                    else:
                        value = input_widget.text().strip()
                    if value:
                        options[field.key] = value

            if options:
                if "provider" not in config:
                    config["provider"] = {}
                if self.provider.id not in config["provider"]:
                    config["provider"][self.provider.id] = {}
                config["provider"][self.provider.id]["options"] = options
                self.main_window.opencode_config = config
                self.main_window.save_opencode_config()

        self.accept()


# ==================== Model 页面 ====================



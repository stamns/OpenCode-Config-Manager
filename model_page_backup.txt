class ModelPage(BasePage):
    """Model 管理页面"""

    def __init__(self, main_window, parent=None):
        super().__init__(tr("model.title"), parent)
        self.main_window = main_window
        self._setup_ui()
        self._load_providers()
        # 连接配置变更信号
        self.main_window.config_changed.connect(self._on_config_changed)

    def _on_config_changed(self):
        """配置变更时刷新 Provider 列表和模型"""
        current_provider = self.provider_combo.currentText()
        self._load_providers()
        # 尝试恢复之前选中的 Provider
        idx = self.provider_combo.findText(current_provider)
        if idx >= 0:
            self.provider_combo.setCurrentIndex(idx)
        elif self.provider_combo.count() > 0:
            self.provider_combo.setCurrentIndex(0)

    def _setup_ui(self):
        # Provider 选择
        provider_layout = QHBoxLayout()
        provider_layout.addWidget(BodyLabel(tr("model.select_provider"), self))
        self.provider_combo = ComboBox(self)
        self.provider_combo.currentTextChanged.connect(self._on_provider_changed)
        provider_layout.addWidget(self.provider_combo)
        provider_layout.addStretch()
        self._layout.addLayout(provider_layout)

        # 工具栏
        toolbar = QHBoxLayout()

        self._bulk_models_owner = "model"

        self.add_btn = PrimaryPushButton(FIF.ADD, tr("model.add_model"), self)
        self.add_btn.clicked.connect(self._on_add)
        toolbar.addWidget(self.add_btn)

        self.preset_btn = PushButton(FIF.LIBRARY, tr("model.add_from_preset"), self)
        self.preset_btn.clicked.connect(self._on_add_preset)
        toolbar.addWidget(self.preset_btn)

        self.edit_btn = PushButton(FIF.EDIT, tr("common.edit"), self)
        self.edit_btn.clicked.connect(self._on_edit)
        toolbar.addWidget(self.edit_btn)

        self.delete_btn = PushButton(FIF.DELETE, tr("common.delete"), self)
        self.delete_btn.clicked.connect(self._on_delete)
        toolbar.addWidget(self.delete_btn)

        self.bulk_model_label = BodyLabel(tr("model.bulk_model"), self)
        toolbar.addWidget(self.bulk_model_label)
        self.bulk_model_combo = ComboBox(self)
        self.bulk_model_combo.setMinimumWidth(220)
        toolbar.addWidget(self.bulk_model_combo)

        toolbar.addStretch()
        self._layout.addLayout(toolbar)

        # Agent 列表
        self.table = TableWidget(self)

        self.table.setColumnCount(5)
        self.table.setHorizontalHeaderLabels(
            [
                tr("model.model_id"),
                tr("model.model_name"),
                tr("model.context"),
                tr("model.output"),
                tr("model.attachment"),
            ]
        )
        # 调整列宽：模型ID和显示名称加宽，上下文/输出/附件各10字符(约80px)
        header = self.table.horizontalHeader()
        header.setSectionResizeMode(0, QHeaderView.Stretch)  # 模型ID 均分
        header.setSectionResizeMode(1, QHeaderView.Stretch)  # 显示名称 均分
        header.setSectionResizeMode(2, QHeaderView.Fixed)
        header.resizeSection(2, 120)  # 上下文 15字符
        header.setSectionResizeMode(3, QHeaderView.Fixed)
        header.resizeSection(3, 80)  # 输出 10字符
        header.setSectionResizeMode(4, QHeaderView.Fixed)
        header.resizeSection(4, 60)  # 附件 10字符
        self.table.setSelectionBehavior(QAbstractItemView.SelectRows)
        self.table.setSelectionMode(QAbstractItemView.SingleSelection)
        self.table.setEditTriggers(QAbstractItemView.NoEditTriggers)
        self.table.doubleClicked.connect(self._on_edit)
        self._layout.addWidget(self.table)

    def _load_providers(self):
        """加载 Provider 列表"""
        self.provider_combo.clear()
        config = self.main_window.opencode_config or {}
        providers = config.get("provider", {})
        for name in providers.keys():
            self.provider_combo.addItem(name)

    def _on_provider_changed(self, provider_name: str):
        """Provider 切换时刷新模型列表"""
        self._load_models(provider_name)

    def _load_models(self, provider_name: str):
        """加载指定 Provider 的模型列表"""
        self.table.setRowCount(0)
        if not provider_name:
            return

        config = self.main_window.opencode_config or {}
        provider = config.get("provider", {}).get(provider_name, {})
        if not isinstance(provider, dict):
            return
        models = provider.get("models", {})

        for model_id, data in models.items():
            row = self.table.rowCount()
            self.table.insertRow(row)
            self.table.setItem(row, 0, QTableWidgetItem(model_id))
            self.table.setItem(row, 1, QTableWidgetItem(data.get("name", "")))
            limit = data.get("limit", {})
            self.table.setItem(row, 2, QTableWidgetItem(str(limit.get("context", ""))))
            self.table.setItem(row, 3, QTableWidgetItem(str(limit.get("output", ""))))
            self.table.setItem(
                row, 4, QTableWidgetItem("✓" if data.get("attachment") else "")
            )

    def _on_add(self):
        """添加模型"""
        provider = self.provider_combo.currentText()
        if not provider:
            self.show_warning(tr("common.info"), tr("model.select_provider_first"))
            return
        dialog = ModelDialog(self.main_window, provider, parent=self)
        if dialog.exec_():
            self._load_models(provider)
            self.show_success(tr("common.success"), tr("model.added_success"))

    def _on_add_preset(self):
        """从预设添加模型"""
        provider = self.provider_combo.currentText()
        if not provider:
            self.show_warning(tr("common.info"), tr("model.select_provider_first"))
            return
        dialog = PresetModelDialog(self.main_window, provider, parent=self)
        if dialog.exec_():
            self._load_models(provider)
            self.show_success(tr("common.success"), tr("model.preset_added_success"))

    def _on_edit(self):
        """编辑模型"""
        provider = self.provider_combo.currentText()
        row = self.table.currentRow()
        if row < 0:
            self.show_warning(tr("common.info"), tr("model.select_model_first"))
            return
        model_id = self.table.item(row, 0).text()
        dialog = ModelDialog(self.main_window, provider, model_id=model_id, parent=self)
        if dialog.exec_():
            self._load_models(provider)
            self.show_success(tr("common.success"), tr("model.updated_success"))

    def _on_delete(self):
        """删除模型"""
        provider = self.provider_combo.currentText()
        row = self.table.currentRow()
        if row < 0:
            self.show_warning(tr("common.info"), tr("model.select_model_first"))
            return

        model_id = self.table.item(row, 0).text()
        w = FluentMessageBox(
            tr("model.delete_confirm_title"),
            tr("model.delete_confirm", name=model_id),
            self,
        )
        if w.exec_():
            config = self.main_window.opencode_config or {}
            if "provider" in config and provider in config["provider"]:
                models = config["provider"][provider].get("models", {})
                if model_id in models:
                    del models[model_id]
                    self.main_window.save_opencode_config()
                    self._load_models(provider)
                    self.show_success(
                        tr("common.success"), tr("model.deleted_success", name=model_id)
                    )


class ModelDialog(BaseDialog):
    """模型编辑对话框 - 完整版本，包含 Options/Variants Tab"""

    def __init__(
        self, main_window, provider_name: str, model_id: str = None, parent=None
    ):
        super().__init__(parent)
        self.main_window = main_window
        self.provider_name = provider_name
        self.model_id = model_id
        self.is_edit = model_id is not None
        self.current_model_data = {"options": {}, "variants": {}}

        self.setWindowTitle("编辑模型" if self.is_edit else "添加模型")
        self.setMinimumSize(750, 750)
        self._setup_ui()
        self._apply_enhanced_style()

        if self.is_edit:
            self._load_model_data()

    def _apply_enhanced_style(self):
        """应用增强样式 - 增加层叠感"""
        if isDarkTheme():
            self.setStyleSheet(
                self.styleSheet()
                + """
                /* Tab/Pivot 样式增强 */
                Pivot {
                    background-color: #161b22;
                    border-radius: 6px;
                    padding: 4px;
                }
                /* 卡片样式增强 */
                CardWidget {
                    background-color: #161b22;
                    border: 1px solid #30363d;
                    border-radius: 8px;
                    margin: 4px 0;
                }
                /* 表格样式增强 - Antigravity 风格 */
                QTableWidget, TableWidget {
                    background-color: #0d1117;
                    border: none;
                    border-radius: 8px;
                    gridline-color: transparent;
                    outline: none;
                }
                QTableWidget::item, TableWidget::item {
                    padding: 12px 16px;
                    border: none;
                    border-bottom: 1px solid #21262d;
                    color: #e6edf3;
                }
                QTableWidget::item:selected, TableWidget::item:selected {
                    background-color: #1f6feb;
                    color: #ffffff;
                }
                QTableWidget::item:hover, TableWidget::item:hover {
                    background-color: #161b22;
                }
                QHeaderView::section {
                    background-color: #0d1117;
                    color: #7d8590;
                    border: none;
                    border-bottom: 1px solid #21262d;
                    padding: 12px 16px;
                    font-weight: 600;
                    font-size: 12px;
                }
                QHeaderView {
                    background-color: #0d1117;
                }
                /* 滚动条样式 */
                QScrollBar:vertical {
                    background-color: #0d1117;
                    width: 8px;
                    border-radius: 4px;
                }
                QScrollBar::handle:vertical {
                    background-color: #30363d;
                    border-radius: 4px;
                    min-height: 30px;
                }
                QScrollBar::handle:vertical:hover {
                    background-color: #484f58;
                }
                /* 分组标题样式 */
                CaptionLabel {
                    color: #58a6ff;
                    font-weight: bold;
                    padding: 4px 0;
                }
            """
            )

    def _setup_ui(self):
        layout = QVBoxLayout(self)
        layout.setSpacing(12)
        layout.setContentsMargins(16, 16, 16, 16)

        # ===== 基本信息区域 =====
        basic_card = CardWidget(self)
        basic_layout = QVBoxLayout(basic_card)
        basic_layout.setSpacing(10)
        basic_layout.setContentsMargins(16, 12, 16, 12)

        # 标题
        basic_layout.addWidget(SubtitleLabel("基本信息", basic_card))

        # 模型ID
        id_layout = QHBoxLayout()
        id_layout.addWidget(BodyLabel("模型 ID:", self))
        self.id_edit = LineEdit(self)
        self.id_edit.setPlaceholderText("如: claude-sonnet-4-5-20250929")
        self.id_edit.setToolTip(get_tooltip("model_id"))
        if self.is_edit:
            self.id_edit.setEnabled(False)
        id_layout.addWidget(self.id_edit)
        basic_layout.addLayout(id_layout)

        # 显示名称
        name_layout = QHBoxLayout()
        name_layout.addWidget(BodyLabel("显示名称:", self))
        self.name_edit = LineEdit(self)
        self.name_edit.setToolTip(get_tooltip("model_name"))
        name_layout.addWidget(self.name_edit)
        basic_layout.addLayout(name_layout)

        # 支持附件
        self.attachment_check = CheckBox("支持附件 (图片/文档)", self)
        self.attachment_check.setToolTip(get_tooltip("model_attachment"))
        basic_layout.addWidget(self.attachment_check)

        # Modalities 输入/输出模态
        modalities_layout = QHBoxLayout()
        modalities_layout.addWidget(BodyLabel("输入模态:", self))
        self.input_text_check = CheckBox("text", self)
        self.input_text_check.setChecked(True)
        modalities_layout.addWidget(self.input_text_check)
        self.input_image_check = CheckBox("image", self)
        modalities_layout.addWidget(self.input_image_check)
        self.input_audio_check = CheckBox("audio", self)
        modalities_layout.addWidget(self.input_audio_check)
        self.input_video_check = CheckBox("video", self)
        modalities_layout.addWidget(self.input_video_check)
        modalities_layout.addSpacing(20)
        modalities_layout.addWidget(BodyLabel("输出模态:", self))
        self.output_text_check = CheckBox("text", self)
        self.output_text_check.setChecked(True)
        modalities_layout.addWidget(self.output_text_check)
        self.output_image_check = CheckBox("image", self)
        modalities_layout.addWidget(self.output_image_check)
        self.output_audio_check = CheckBox("audio", self)
        modalities_layout.addWidget(self.output_audio_check)
        modalities_layout.addStretch()
        basic_layout.addLayout(modalities_layout)

        # 上下文窗口和最大输出
        limit_layout = QHBoxLayout()
        limit_layout.addWidget(BodyLabel("上下文窗口:", self))
        self.context_spin = SpinBox(self)
        self.context_spin.setRange(0, 10000000)
        self.context_spin.setValue(200000)
        self.context_spin.setMinimumWidth(120)
        self.context_spin.setToolTip(get_tooltip("model_context"))
        limit_layout.addWidget(self.context_spin)
        limit_layout.addSpacing(20)
        limit_layout.addWidget(BodyLabel("最大输出:", self))
        self.output_spin = SpinBox(self)
        self.output_spin.setRange(0, 1000000)
        self.output_spin.setValue(16000)
        self.output_spin.setMinimumWidth(100)
        self.output_spin.setToolTip(get_tooltip("model_output"))
        limit_layout.addWidget(self.output_spin)
        basic_layout.addLayout(limit_layout)

        layout.addWidget(basic_card)

        # ===== Tab 切换区域 =====
        tab_container = CardWidget(self)
        tab_layout = QVBoxLayout(tab_container)
        tab_layout.setContentsMargins(12, 8, 12, 12)

        self.pivot = Pivot(self)
        self.stacked_widget = QStackedWidget(self)

        # Options Tab
        self.options_widget = QWidget()
        self._setup_options_tab(self.options_widget)
        self.stacked_widget.addWidget(self.options_widget)
        self.pivot.addItem(routeKey="options", text="Options 配置")

        # Variants Tab
        self.variants_widget = QWidget()
        self._setup_variants_tab(self.variants_widget)
        self.stacked_widget.addWidget(self.variants_widget)
        self.pivot.addItem(routeKey="variants", text="Variants 变体")

        self.pivot.currentItemChanged.connect(
            lambda k: self.stacked_widget.setCurrentIndex(0 if k == "options" else 1)
        )
        self.pivot.setCurrentItem("options")

        tab_layout.addWidget(self.pivot)
        tab_layout.addWidget(self.stacked_widget, 1)

        layout.addWidget(tab_container, 1)

        # ===== 按钮区域 =====
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()

        self.cancel_btn = PushButton("取消", self)
        self.cancel_btn.clicked.connect(self.reject)
        btn_layout.addWidget(self.cancel_btn)

        self.save_btn = PrimaryPushButton("保存", self)
        self.save_btn.clicked.connect(self._on_save)
        btn_layout.addWidget(self.save_btn)

        layout.addLayout(btn_layout)

    def _setup_options_tab(self, parent):
        """设置 Options Tab - 使用 ScrollArea 解决空间不足问题"""
        # 主布局
        main_layout = QVBoxLayout(parent)
        main_layout.setSpacing(0)
        main_layout.setContentsMargins(0, 0, 0, 0)

        # 创建滚动区域
        scroll_area = QScrollArea(parent)
        scroll_area.setWidgetResizable(True)
        scroll_area.setFrameShape(QFrame.NoFrame)
        scroll_area.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
        scroll_area.setStyleSheet(
            "QScrollArea { background: transparent; border: none; }"
        )

        # 滚动内容容器
        scroll_content = QWidget()
        scroll_content.setStyleSheet("QWidget { background: transparent; }")
        layout = QVBoxLayout(scroll_content)
        layout.setSpacing(10)
        layout.setContentsMargins(4, 8, 4, 8)

        # Claude Thinking 快捷按钮
        claude_card = CardWidget(scroll_content)
        claude_layout = QVBoxLayout(claude_card)
        claude_layout.setContentsMargins(8, 6, 8, 6)
        claude_layout.setSpacing(6)
        claude_layout.addWidget(CaptionLabel("Claude Thinking 配置", claude_card))
        claude_btn_layout = QHBoxLayout()
        claude_btn_layout.setSpacing(6)

        btn_thinking_type = PushButton("type=enabled", claude_card)
        btn_thinking_type.setToolTip(get_tooltip("option_thinking_type"))
        btn_thinking_type.setFixedHeight(32)
        btn_thinking_type.clicked.connect(
            lambda: self._add_thinking_config("type", "enabled")
        )
        claude_btn_layout.addWidget(btn_thinking_type)

        btn_budget = PushButton("budget=16000", claude_card)
        btn_budget.setToolTip(get_tooltip("option_thinking_budget"))
        btn_budget.setFixedHeight(32)
        btn_budget.clicked.connect(
            lambda: self._add_thinking_config("budgetTokens", 16000)
        )
        claude_btn_layout.addWidget(btn_budget)

        btn_full = PrimaryPushButton("一键添加", claude_card)
        btn_full.setFixedHeight(32)
        btn_full.clicked.connect(self._add_full_thinking_config)
        claude_btn_layout.addWidget(btn_full)

        claude_layout.addLayout(claude_btn_layout)
        layout.addWidget(claude_card)

        # OpenAI 推理快捷按钮
        openai_card = CardWidget(scroll_content)
        openai_layout = QVBoxLayout(openai_card)
        openai_layout.setContentsMargins(8, 6, 8, 6)
        openai_layout.setSpacing(6)
        openai_layout.addWidget(CaptionLabel("OpenAI 推理配置", openai_card))
        openai_btn_layout = QHBoxLayout()
        openai_btn_layout.setSpacing(6)

        openai_presets = [
            ("reasoning", "high", "option_reasoningEffort"),
            ("verbosity", "low", "option_textVerbosity"),
            ("summary", "auto", "option_reasoningSummary"),
        ]
        for key, val, tooltip_key in openai_presets:
            btn = PushButton(f"{key}={val}", openai_card)
            btn.setToolTip(get_tooltip(tooltip_key))
            btn.setFixedHeight(32)
            btn.clicked.connect(
                lambda checked, k=key, v=val: self._add_option_preset(k, v)
            )
            openai_btn_layout.addWidget(btn)

        openai_layout.addLayout(openai_btn_layout)
        layout.addWidget(openai_card)

        # Gemini Thinking 快捷按钮
        gemini_card = CardWidget(scroll_content)
        gemini_layout = QVBoxLayout(gemini_card)
        gemini_layout.setContentsMargins(8, 6, 8, 6)
        gemini_layout.setSpacing(6)
        gemini_layout.addWidget(CaptionLabel("Gemini Thinking 配置", gemini_card))
        gemini_btn_layout = QHBoxLayout()
        gemini_btn_layout.setSpacing(6)

        btn_gemini_8k = PushButton("budget=8000", gemini_card)
        btn_gemini_8k.setToolTip(get_tooltip("option_thinking_budget"))
        btn_gemini_8k.setFixedHeight(32)
        btn_gemini_8k.clicked.connect(lambda: self._add_gemini_thinking_config(8000))
        gemini_btn_layout.addWidget(btn_gemini_8k)

        btn_gemini_16k = PushButton("budget=16000", gemini_card)
        btn_gemini_16k.setToolTip(get_tooltip("option_thinking_budget"))
        btn_gemini_16k.setFixedHeight(32)
        btn_gemini_16k.clicked.connect(lambda: self._add_gemini_thinking_config(16000))
        gemini_btn_layout.addWidget(btn_gemini_16k)

        gemini_layout.addLayout(gemini_btn_layout)
        layout.addWidget(gemini_card)

        # Options 列表
        options_label = BodyLabel("Options 键值对列表:", scroll_content)
        options_label.setToolTip(get_tooltip("model_options"))
        layout.addWidget(options_label)

        self.options_table = TableWidget(scroll_content)
        self.options_table.setColumnCount(2)
        self.options_table.setHorizontalHeaderLabels(["键", "值"])
        self.options_table.horizontalHeader().setSectionResizeMode(QHeaderView.Stretch)
        self.options_table.setSelectionBehavior(QAbstractItemView.SelectRows)
        self.options_table.setMinimumHeight(100)
        self.options_table.setMaximumHeight(150)
        self.options_table.verticalHeader().setDefaultSectionSize(28)
        self.options_table.horizontalHeader().setFixedHeight(35)
        self.options_table.horizontalHeader().setDefaultAlignment(Qt.AlignCenter)
        layout.addWidget(self.options_table)

        # 键值输入 - 单行紧凑布局
        input_layout = QHBoxLayout()
        input_layout.setSpacing(8)

        key_label = BodyLabel("键:", scroll_content)
        key_label.setFixedWidth(24)
        input_layout.addWidget(key_label)

        self.option_key_edit = LineEdit(scroll_content)
        self.option_key_edit.setPlaceholderText("temperature")
        self.option_key_edit.setFixedHeight(32)
        input_layout.addWidget(self.option_key_edit, 1)

        value_label = BodyLabel("值:", scroll_content)
        value_label.setFixedWidth(24)
        input_layout.addWidget(value_label)

        self.option_value_edit = LineEdit(scroll_content)
        self.option_value_edit.setPlaceholderText("0.7")
        self.option_value_edit.setFixedHeight(32)
        input_layout.addWidget(self.option_value_edit, 1)

        layout.addLayout(input_layout)

        # 添加/删除按钮
        opt_btn_layout = QHBoxLayout()
        opt_btn_layout.setSpacing(8)
        add_opt_btn = PrimaryPushButton("添加", scroll_content)
        add_opt_btn.setFixedHeight(32)
        add_opt_btn.clicked.connect(self._add_option)
        opt_btn_layout.addWidget(add_opt_btn)
        del_opt_btn = PushButton("删除选中", scroll_content)
        del_opt_btn.setFixedHeight(32)
        del_opt_btn.clicked.connect(self._delete_option)
        opt_btn_layout.addWidget(del_opt_btn)
        opt_btn_layout.addStretch()
        layout.addLayout(opt_btn_layout)

        # 添加弹性空间
        layout.addStretch()

        # 设置滚动区域内容
        scroll_area.setWidget(scroll_content)
        main_layout.addWidget(scroll_area)

    def _setup_variants_tab(self, parent):
        """设置 Variants Tab"""
        layout = QVBoxLayout(parent)
        layout.setSpacing(12)
        layout.setContentsMargins(4, 8, 4, 8)

        variants_label = BodyLabel("模型变体配置 (Variants):", parent)
        variants_label.setToolTip(get_tooltip("model_variants"))
        layout.addWidget(variants_label)

        # Variants 列表
        self.variants_table = TableWidget(parent)
        self.variants_table.setColumnCount(2)
        self.variants_table.setHorizontalHeaderLabels(["变体名称", "配置"])
        self.variants_table.horizontalHeader().setSectionResizeMode(QHeaderView.Stretch)
        self.variants_table.setSelectionBehavior(QAbstractItemView.SelectRows)
        self.variants_table.setMinimumHeight(120)
        self.variants_table.verticalHeader().setDefaultSectionSize(36)
        self.variants_table.horizontalHeader().setMinimumHeight(32)
        self.variants_table.itemSelectionChanged.connect(self._on_variant_select)
        layout.addWidget(self.variants_table)

        # 变体名称输入
        name_layout = QHBoxLayout()
        name_layout.setSpacing(8)
        name_label = BodyLabel("变体名:", parent)
        name_label.setMinimumWidth(50)
        name_layout.addWidget(name_label)
        self.variant_name_edit = LineEdit(parent)
        self.variant_name_edit.setPlaceholderText("high, low, thinking")
        self.variant_name_edit.setMinimumHeight(36)
        name_layout.addWidget(self.variant_name_edit)
        layout.addLayout(name_layout)

        # 预设名称按钮
        preset_layout = QHBoxLayout()
        preset_layout.setSpacing(6)
        preset_layout.addWidget(CaptionLabel("预设:", parent))
        for name in ["high", "low", "thinking", "fast", "default"]:
            btn = PushButton(name, parent)
            btn.setMinimumHeight(30)
            btn.clicked.connect(
                lambda checked, n=name: self.variant_name_edit.setText(n)
            )
            preset_layout.addWidget(btn)
        preset_layout.addStretch()
        layout.addLayout(preset_layout)

        # JSON 配置编辑器
        layout.addWidget(BodyLabel("配置 (JSON):", parent))
        self.variant_config_edit = TextEdit(parent)
        self.variant_config_edit.setPlaceholderText('{"reasoningEffort": "high"}')
        self.variant_config_edit.setMinimumHeight(80)
        self.variant_config_edit.setMaximumHeight(100)
        layout.addWidget(self.variant_config_edit)

        # 添加/删除按钮
        var_btn_layout = QHBoxLayout()
        var_btn_layout.setSpacing(8)
        add_var_btn = PrimaryPushButton("添加变体", parent)
        add_var_btn.setMinimumHeight(36)
        add_var_btn.clicked.connect(self._add_variant)
        var_btn_layout.addWidget(add_var_btn)
        del_var_btn = PushButton("删除变体", parent)
        del_var_btn.setMinimumHeight(36)
        del_var_btn.clicked.connect(self._delete_variant)
        var_btn_layout.addWidget(del_var_btn)
        var_btn_layout.addStretch()
        layout.addLayout(var_btn_layout)

        layout.addStretch()

    # ===== Options 辅助方法 =====
    def _add_thinking_config(self, param, value):
        """添加 Claude thinking 配置参数"""
        options = self.current_model_data.setdefault("options", {})
        thinking = options.setdefault("thinking", {})
        thinking[param] = value
        self._refresh_options_table()

    def _add_full_thinking_config(self):
        """一键添加完整的 Claude thinking 配置"""
        options = self.current_model_data.setdefault("options", {})
        options["thinking"] = {"type": "enabled", "budgetTokens": 16000}
        self._refresh_options_table()
        InfoBar.success(
            "成功", "已添加 Claude Thinking 配置", parent=self, duration=2000
        )

    def _add_gemini_thinking_config(self, budget):
        """添加 Gemini thinking 配置"""
        options = self.current_model_data.setdefault("options", {})
        options["thinkingConfig"] = {"thinkingBudget": budget}
        self._refresh_options_table()

    def _add_option_preset(self, key, value):
        """添加预设 option"""
        self.option_key_edit.setText(key)
        self.option_value_edit.setText(str(value))

    def _add_option(self):
        """添加自定义 option"""
        key = self.option_key_edit.text().strip()
        value = self.option_value_edit.text().strip()
        if not key:
            return
        # 尝试转换值类型
        try:
            if value.lower() == "true":
                value = True
            elif value.lower() == "false":
                value = False
            elif value.isdigit():
                value = int(value)
            elif value.replace(".", "", 1).isdigit():
                value = float(value)
        except Exception:
            pass
        self.current_model_data.setdefault("options", {})[key] = value
        self._refresh_options_table()
        self.option_key_edit.clear()
        self.option_value_edit.clear()

    def _delete_option(self):
        """删除选中的 option"""
        selected = self.options_table.selectedItems()
        if not selected:
            return
        row = selected[0].row()
        key = self.options_table.item(row, 0).text()
        options = self.current_model_data.get("options", {})
        if key in options:
            del options[key]
            self._refresh_options_table()

    def _refresh_options_table(self):
        """刷新 options 表格"""
        self.options_table.setRowCount(0)
        options = self.current_model_data.get("options", {})
        for key, value in options.items():
            row = self.options_table.rowCount()
            self.options_table.insertRow(row)
            self.options_table.setItem(row, 0, QTableWidgetItem(str(key)))
            self.options_table.setItem(row, 1, QTableWidgetItem(str(value)))

    # ===== Variants 辅助方法 =====
    def _on_variant_select(self):
        """选中变体时加载配置"""
        selected = self.variants_table.selectedItems()
        if not selected:
            return
        row = selected[0].row()
        name = self.variants_table.item(row, 0).text()
        variants = self.current_model_data.get("variants", {})
        if name in variants:
            self.variant_name_edit.setText(name)
            self.variant_config_edit.setPlainText(
                json.dumps(variants[name], indent=2, ensure_ascii=False)
            )

    def _add_variant(self):
        """添加变体"""
        name = self.variant_name_edit.text().strip()
        if not name:
            InfoBar.warning("提示", "请输入变体名称", parent=self)
            return
        try:
            config = json.loads(self.variant_config_edit.toPlainText().strip() or "{}")
        except json.JSONDecodeError as e:
            InfoBar.error("错误", f"JSON 格式错误: {e}", parent=self)
            return
        self.current_model_data.setdefault("variants", {})[name] = config
        self._refresh_variants_table()
        self.variant_name_edit.clear()

    def _delete_variant(self):
        """删除选中的变体"""
        selected = self.variants_table.selectedItems()
        if not selected:
            return
        row = selected[0].row()
        name = self.variants_table.item(row, 0).text()
        variants = self.current_model_data.get("variants", {})
        if name in variants:
            del variants[name]
            self._refresh_variants_table()

    def _refresh_variants_table(self):
        """刷新 variants 表格"""
        self.variants_table.setRowCount(0)
        variants = self.current_model_data.get("variants", {})
        for name, config in variants.items():
            row = self.variants_table.rowCount()
            self.variants_table.insertRow(row)
            self.variants_table.setItem(row, 0, QTableWidgetItem(name))
            config_str = json.dumps(config, ensure_ascii=False)
            if len(config_str) > 50:
                config_str = config_str[:50] + "..."
            self.variants_table.setItem(row, 1, QTableWidgetItem(config_str))

    def _load_model_data(self):
        """加载模型数据"""
        config = self.main_window.opencode_config or {}
        provider = config.get("provider", {}).get(self.provider_name, {})
        if not isinstance(provider, dict):
            return
        model = provider.get("models", {}).get(self.model_id, {})

        self.id_edit.setText(self.model_id)
        self.name_edit.setText(model.get("name", ""))
        self.attachment_check.setChecked(model.get("attachment", False))

        # 加载 modalities
        modalities = model.get("modalities", {})
        input_modalities = modalities.get("input", ["text"])
        output_modalities = modalities.get("output", ["text"])
        self.input_text_check.setChecked("text" in input_modalities)
        self.input_image_check.setChecked("image" in input_modalities)
        self.input_audio_check.setChecked("audio" in input_modalities)
        self.input_video_check.setChecked("video" in input_modalities)
        self.output_text_check.setChecked("text" in output_modalities)
        self.output_image_check.setChecked("image" in output_modalities)
        self.output_audio_check.setChecked("audio" in output_modalities)

        limit = model.get("limit", {})
        self.context_spin.setValue(limit.get("context", 200000))
        self.output_spin.setValue(limit.get("output", 16000))

        # 加载 options 和 variants
        self.current_model_data["options"] = model.get("options", {}).copy()
        self.current_model_data["variants"] = model.get("variants", {}).copy()
        self._refresh_options_table()
        self._refresh_variants_table()

    def _on_save(self):
        """保存模型"""
        model_id = self.id_edit.text().strip()
        if not model_id:
            InfoBar.error("错误", "请输入模型 ID", parent=self)
            return

        config = self.main_window.opencode_config
        if config is None:
            config = {}
            self.main_window.opencode_config = config

        if "provider" not in config:
            config["provider"] = {}

        # 验证 Provider 是否存在且结构完整
        if self.provider_name not in config["provider"]:
            InfoBar.error(
                "错误",
                f'Provider "{self.provider_name}" 不存在，请先在 Provider 管理页面创建',
                parent=self,
            )
            return

        provider = config["provider"][self.provider_name]

        # 检查 Provider 结构是否完整
        if "npm" not in provider or "options" not in provider:
            InfoBar.error(
                "错误",
                f'Provider "{self.provider_name}" 配置不完整，请先在 Provider 管理页面完善配置',
                parent=self,
            )
            return

        # 确保 models 字段存在
        if "models" not in provider:
            provider["models"] = {}

        models = provider["models"]

        # 检查名称冲突
        if not self.is_edit and model_id in models:
            InfoBar.error("错误", f'模型 "{model_id}" 已存在', parent=self)
            return

        # 保存数据
        model_data = {
            "name": self.name_edit.text().strip(),
            "attachment": self.attachment_check.isChecked(),
            "limit": {
                "context": self.context_spin.value(),
                "output": self.output_spin.value(),
            },
        }

        # 保存 modalities
        input_modalities = []
        if self.input_text_check.isChecked():
            input_modalities.append("text")
        if self.input_image_check.isChecked():
            input_modalities.append("image")
        if self.input_audio_check.isChecked():
            input_modalities.append("audio")
        if self.input_video_check.isChecked():
            input_modalities.append("video")
        output_modalities = []
        if self.output_text_check.isChecked():
            output_modalities.append("text")
        if self.output_image_check.isChecked():
            output_modalities.append("image")
        if self.output_audio_check.isChecked():
            output_modalities.append("audio")
        if input_modalities or output_modalities:
            model_data["modalities"] = {
                "input": input_modalities if input_modalities else ["text"],
                "output": output_modalities if output_modalities else ["text"],
            }

        # 保存前进行配置校验，避免写入错误结构
        temp_provider = dict(provider)
        temp_models = dict(temp_provider.get("models", {}))
        temp_models[model_id] = model_data
        temp_provider["models"] = temp_models
        temp_config = dict(config)
        temp_providers = dict(temp_config.get("provider", {}))
        temp_providers[self.provider_name] = temp_provider
        temp_config["provider"] = temp_providers
        issues = ConfigValidator.validate_opencode_config(temp_config)
        errors = [i for i in issues if i["level"] == "error"]
        if errors:
            msg = "\n".join(f"• {e['message']}" for e in errors[:8])
            if len(errors) > 8:
                msg += f"\n... 还有 {len(errors) - 8} 个错误"
            InfoBar.error("错误", f"配置校验失败：\n{msg}", parent=self)
            return

        options = self.current_model_data.get("options", {})
        if options:
            model_data["options"] = options
        variants = self.current_model_data.get("variants", {})
        if variants:
            model_data["variants"] = variants

        models[model_id] = model_data
        self.main_window.save_opencode_config()
        self.accept()


class PresetModelDialog(BaseDialog):
    """预设模型选择对话框"""

    def __init__(self, main_window, provider_name: str, parent=None):
        super().__init__(parent)
        self.main_window = main_window
        self.provider_name = provider_name

        self.setWindowTitle("从预设添加模型")
        self.setMinimumSize(500, 400)
        self._setup_ui()

    def _setup_ui(self):
        layout = QVBoxLayout(self)
        layout.setSpacing(12)

        # 模型系列选择
        series_layout = QHBoxLayout()
        series_layout.addWidget(BodyLabel("模型系列:", self))
        self.series_combo = ComboBox(self)
        self.series_combo.addItems(list(PRESET_MODEL_CONFIGS.keys()))
        self.series_combo.currentTextChanged.connect(self._on_series_changed)
        series_layout.addWidget(self.series_combo)
        layout.addLayout(series_layout)

        # 模型列表
        layout.addWidget(BodyLabel(tr("cli_export.select_model") + ":", self))
        self.model_list = ListWidget(self)
        self.model_list.setSelectionMode(QAbstractItemView.MultiSelection)
        layout.addWidget(self.model_list)

        # 模型描述
        self.desc_label = CaptionLabel("", self)
        self.desc_label.setWordWrap(True)
        layout.addWidget(self.desc_label)

        # 按钮
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()

        self.cancel_btn = PushButton(tr("common.cancel"), self)
        self.cancel_btn.clicked.connect(self.reject)
        btn_layout.addWidget(self.cancel_btn)

        self.save_btn = PrimaryPushButton(tr("common.save"), self)
        self.save_btn.clicked.connect(self._on_save)
        btn_layout.addWidget(self.save_btn)

        layout.addLayout(btn_layout)

        # 初始化
        self._on_series_changed(self.series_combo.currentText())

    def _on_series_changed(self, series: str):
        self.model_list.clear()
        if series in PRESET_MODEL_CONFIGS:
            models = PRESET_MODEL_CONFIGS[series]["models"]
            for model_id, data in models.items():
                self.model_list.addItem(f"{model_id} - {data.get('name', '')}")

    def _on_add(self):
        selected = self.model_list.selectedItems()
        if not selected:
            InfoBar.warning("提示", "请选择至少一个模型", parent=self)
            return

        series = self.series_combo.currentText()
        series_data = PRESET_MODEL_CONFIGS.get(series, {})
        models_data = series_data.get("models", {})

        config = self.main_window.opencode_config
        if config is None:
            config = {}
            self.main_window.opencode_config = config

        if "provider" not in config:
            config["provider"] = {}

        # 验证 Provider 是否存在且结构完整
        if self.provider_name not in config["provider"]:
            InfoBar.error(
                "错误",
                f'Provider "{self.provider_name}" 不存在，请先在 Provider 管理页面创建',
                parent=self,
            )
            return

        provider = config["provider"][self.provider_name]

        # 检查 Provider 结构是否完整
        if "npm" not in provider or "options" not in provider:
            InfoBar.error(
                "错误",
                f'Provider "{self.provider_name}" 配置不完整，请先在 Provider 管理页面完善配置',
                parent=self,
            )
            return

        # 确保 models 字段存在
        if "models" not in provider:
            provider["models"] = {}

        models = provider["models"]
        added = 0

        for item in selected:
            model_id = item.text().split(" - ")[0]
            if model_id in models_data:
                preset = models_data[model_id]
                models[model_id] = {
                    "name": preset.get("name", ""),
                    "attachment": preset.get("attachment", False),
                    "limit": preset.get("limit", {}),
                    "options": preset.get("options", {}),
                    "variants": preset.get("variants", {}),
                }
                added += 1

        self.main_window.save_opencode_config()
        InfoBar.success("成功", f"已添加 {added} 个模型", parent=self)
        self.accept()


# ==================== MCP 页面 ====================

# 技能市场修复总结

## 问题描述

用户报告技能市场安装失败，出现404错误：
```
失败  网络错误: 404 Client Error: Not Found for url:
https://github.com/openai/test-generator-skill/archive/refs/heads/main.zip
```

## 根本原因

经过验证，`FEATURED_SKILLS`列表中的20个技能仓库**全部不存在**（全部返回404）：
- `vercel-labs/git-release` ❌
- `anthropics/code-review-skill` ❌
- `openai/test-generator-skill` ❌
- ... 等等

这些仓库要么被删除，要么从未存在过。

## 解决方案

### 1. 更新技能列表

将`FEATURED_SKILLS`列表替换为**Anthropic官方技能**（来自`anthropics/skills`仓库）：

**新列表包含12个真实可用的技能**：
1. `mcp-builder` - 创建高质量的 MCP 服务器
2. `web-artifacts-builder` - 使用 React、Tailwind CSS 创建 Web 组件
3. `canvas-design` - 创建精美的视觉艺术和设计作品
4. `theme-factory` - 为各种项目生成和应用主题样式
5. `algorithmic-art` - 使用 p5.js 创建算法艺术
6. `frontend-design` - 前端设计和 UI 组件开发
7. `webapp-testing` - Web 应用自动化测试
8. `skill-creator` - 创建和管理自定义 Skills
9. `doc-coauthoring` - 协作编写和编辑文档
10. `brand-guidelines` - 创建和维护品牌设计规范
11. `internal-comms` - 内部沟通和团队协作工具
12. `slack-gif-creator` - 为 Slack 创建动画 GIF

### 2. 添加子目录支持

由于这些技能位于`anthropics/skills`仓库的子目录中（如`skills/mcp-builder`），需要修改安装逻辑：

**修改的文件和方法**：
- `SkillInstaller.install_from_github()` - 添加`subdir`参数
- `SkillUpdater.update_skill()` - 支持从元数据中读取`subdir`
- `SkillPage._on_open_market()` - 传递`skill.get("path")`作为`subdir`

**关键修改点**：
```python
# 1. 在FEATURED_SKILLS中添加path字段
{
    "name": "mcp-builder",
    "repo": "anthropics/skills",
    "path": "skills/mcp-builder",  # 新增
    ...
}

# 2. install_from_github方法支持subdir参数
def install_from_github(owner, repo, branch, target_dir, subdir=None, ...):
    if subdir:
        skill_dir = extracted_dir / subdir
    else:
        skill_dir = extracted_dir
    skill_md = skill_dir / "SKILL.md"
    ...

# 3. 在元数据中记录subdir
if subdir:
    meta["subdir"] = subdir
```

### 3. 更新翻译文件

**添加的翻译键**：

**中文 (zh_CN.json)**：
```json
{
  "skill": {
    "categories": {
      "creative": "创意设计"
    },
    "market_skills": {
      "mcp_builder_desc": "创建高质量的 MCP (Model Context Protocol) 服务器",
      "web_artifacts_builder_desc": "使用 React、Tailwind CSS、shadcn/ui 创建复杂的 Web 组件",
      "canvas_design_desc": "创建精美的视觉艺术和设计作品（PNG/PDF）",
      "theme_factory_desc": "为各种项目生成和应用主题样式",
      "algorithmic_art_desc": "使用 p5.js 创建算法艺术和生成式艺术",
      "frontend_design_desc": "前端设计和 UI 组件开发",
      "webapp_testing_desc": "Web 应用自动化测试和验证",
      "skill_creator_desc": "创建和管理自定义 Skills",
      "doc_coauthoring_desc": "协作编写和编辑文档",
      "brand_guidelines_desc": "创建和维护品牌设计规范",
      "internal_comms_desc": "内部沟通和团队协作工具",
      "slack_gif_creator_desc": "为 Slack 创建动画 GIF"
    }
  }
}
```

**英文 (en_US.json)**：
```json
{
  "skill": {
    "categories": {
      "creative": "Creative Design"
    },
    "market_skills": {
      "mcp_builder_desc": "Create high-quality MCP (Model Context Protocol) servers",
      "web_artifacts_builder_desc": "Build complex web components with React, Tailwind CSS, shadcn/ui",
      ...
    }
  }
}
```

## 修改的文件

1. **opencode_config_manager_fluent.py**
   - 第 13057-13110 行：替换`FEATURED_SKILLS`列表
   - 第 13593-13720 行：修改`install_from_github`方法，添加`subdir`参数
   - 第 13877-13910 行：修改`update_skill`方法，支持`subdir`
   - 第 14993-15029 行：修改`_on_open_market`方法，传递`subdir`参数

2. **locales/zh_CN.json**
   - 添加`creative`分类翻译
   - 替换所有`market_skills`描述（12个新技能）

3. **locales/en_US.json**
   - 添加`creative`分类翻译
   - 替换所有`market_skills`描述（12个新技能）

## 验证结果

**验证脚本**：`verify_skill_repos.py`

**结果**：
- ❌ 旧列表：20个技能，0个有效，20个无效（100%失败率）
- ✅ 新列表：12个技能，全部来自Anthropic官方仓库，100%可用

## 测试建议

1. **基本安装测试**：
   - 打开技能市场
   - 选择任意技能（如`mcp-builder`）
   - 选择安装位置（如"OpenCode 全局"）
   - 点击安装，验证是否成功

2. **子目录安装测试**：
   - 验证从`anthropics/skills`仓库的子目录正确提取`SKILL.md`
   - 验证安装后的目录结构正确

3. **更新测试**：
   - 安装一个技能后，点击"检查更新"
   - 验证能正确检测更新状态
   - 验证更新功能正常工作

4. **多语言测试**：
   - 切换到英文界面，验证技能描述正确显示
   - 切换回中文界面，验证技能描述正确显示

## 后续优化建议

1. **添加仓库验证**：
   - 在启动时验证`FEATURED_SKILLS`中的仓库是否可访问
   - 缓存验证结果，避免重复检查

2. **错误提示优化**：
   - 当仓库不存在时，提供更友好的错误提示
   - 建议用户检查网络连接或稍后重试

3. **技能来源多样化**：
   - 考虑添加其他来源的技能（如社区贡献）
   - 添加"报告无效技能"功能

4. **性能优化**：
   - 缓存技能列表，减少API调用
   - 添加本地技能索引，加快搜索速度

## 相关文件

- `verify_skill_repos.py` - 仓库验证脚本
- `update_skill_market.py` - 翻译更新脚本
- `opencode_config_manager_fluent.py` - 主程序文件
- `locales/zh_CN.json` - 中文翻译
- `locales/en_US.json` - 英文翻译

## 参考资料

- Anthropic官方技能仓库：https://github.com/anthropics/skills
- Anthropic技能文档：https://support.claude.com/en/articles/12512176-what-are-skills

---

**修复日期**：2026-01-23  
**修复人员**：Sisyphus (OpenCode AI Agent)  
**问题状态**：✅ 已修复
